# MomentDots å¹³å°æ¶æ„æŒ‡å—

**ç‰ˆæœ¬ï¼š** v2.1
**æ›´æ–°æ—¥æœŸï¼š** 2025-01-21
**ä½œè€…ï¼š** MomentDots å¼€å‘å›¢é˜Ÿ

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [å¹³å°åˆ†ç±»ä½“ç³»](#å¹³å°åˆ†ç±»ä½“ç³»)
3. [ç»Ÿä¸€åŸºç±»æ¶æ„](#ç»Ÿä¸€åŸºç±»æ¶æ„)
4. [Aç±»å¹³å°å®ç°è¯¦è§£](#aç±»å¹³å°å®ç°è¯¦è§£)
5. [Bç±»å¹³å°å®ç°è¯¦è§£](#bç±»å¹³å°å®ç°è¯¦è§£)
6. [è·¨æ ‡ç­¾é¡µå¹³å°å®ç°](#è·¨æ ‡ç­¾é¡µå¹³å°å®ç°)
7. [å¾®ä¿¡è§†é¢‘å·æŠ€æœ¯å®ç°](#å¾®ä¿¡è§†é¢‘å·æŠ€æœ¯å®ç°)
8. [é…ç½®ç®¡ç†ä½“ç³»](#é…ç½®ç®¡ç†ä½“ç³»)
9. [å·¥å‚æ¨¡å¼é›†æˆ](#å·¥å‚æ¨¡å¼é›†æˆ)
10. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

MomentDotsæ˜¯ä¸€ä¸ªChromeæµè§ˆå™¨æ‰©å±•ç¨‹åºï¼Œæ—¨åœ¨å®ç°**ä¸€é”®å‘å¸ƒåŠ¨æ€åˆ°å¤šä¸ªç¤¾äº¤åª’ä½“å¹³å°**ã€‚é¡¹ç›®é‡‡ç”¨ç»Ÿä¸€çš„æ¶æ„æ¨¡å¼ï¼Œæ”¯æŒå¾®åšã€å°çº¢ä¹¦ã€å³åˆ»ã€æŠ–éŸ³ã€Xã€Bilibiliã€å¾®ä¿¡å…¬ä¼—å·å’Œå¾®ä¿¡è§†é¢‘å·ç­‰8ä¸ªä¸»æµå¹³å°ã€‚

### æŠ€æœ¯æ ˆ

- **æ ¸å¿ƒæŠ€æœ¯**: Chrome Extension Manifest V3
- **å‰ç«¯æŠ€æœ¯**: åŸç”ŸJavaScript (ES6+)ã€HTML5ã€CSS3
- **æ ·å¼æ¡†æ¶**: Tailwind CSS
- **çŠ¶æ€ç®¡ç†**: Zustand
- **æ„å»ºå·¥å…·**: TypeScriptç¼–è¯‘å™¨ã€Tailwind CSS
- **å¼€å‘å·¥å…·**: Node.jsã€npm
- **æµ‹è¯•å·¥å…·**: Playwright MCP Bridge

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

- **ç»Ÿä¸€æ¶æ„**ï¼šæ‰€æœ‰å¹³å°é€‚é…å™¨éµå¾ªç»Ÿä¸€çš„åŸºç±»æ¶æ„
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªå¹³å°ç‹¬ç«‹é€‚é…å™¨ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **ä»£ç å¤ç”¨**ï¼šæœ€å¤§åŒ–ä»£ç å¤ç”¨ï¼Œæœ€å°åŒ–é‡å¤å®ç°
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé«˜æ•ˆçš„DOMæ“ä½œå’Œå¼‚æ­¥å¤„ç†æœºåˆ¶
- **ç±»å‹å®‰å…¨**ï¼šTypeScriptæä¾›ç±»å‹æ£€æŸ¥å’Œç¼–è¯‘æ—¶é”™è¯¯æ£€æµ‹

## ğŸ—ï¸ å¹³å°åˆ†ç±»ä½“ç³»

åŸºäºå¹³å°çš„æŠ€æœ¯ç‰¹å¾å’Œæ“ä½œæµç¨‹ï¼ŒMomentDotså°†æ‰€æœ‰æ”¯æŒçš„å¹³å°åˆ†ä¸ºä¸‰å¤§ç±»ï¼š

### Aç±»ï¼šç›´æ¥æ³¨å…¥å‹å¹³å°

**æ“ä½œæµç¨‹ï¼š** æ‰“å¼€é¡µé¢ â†’ ç›´æ¥æ³¨å…¥å†…å®¹ï¼ˆæ ‡é¢˜ã€æ­£æ–‡ã€æ–‡ä»¶ï¼‰

**ä»£è¡¨å¹³å°ï¼š**
- å¾®åš (weibo)
- å³åˆ» (jike)
- X (x)
- Bilibili (bilibili)
- **å¾®ä¿¡è§†é¢‘å· (weixinchannels)** â­

**æŠ€æœ¯ç‰¹å¾ï¼š**
- é¡µé¢åŠ è½½å®Œæˆåç«‹å³å¯ä»¥è¿›è¡Œå†…å®¹æ³¨å…¥
- ä¸éœ€è¦é¢å¤–çš„é¡µé¢å¯¼èˆªæˆ–æŒ‰é’®ç‚¹å‡»
- DOMå…ƒç´ åœ¨é¡µé¢åŠ è½½æ—¶å°±å·²ç»å¯ç”¨
- ä½¿ç”¨ç»Ÿä¸€çš„ `PlatformAdapter` åŸºç±»

### Bç±»ï¼šå¤šæ­¥éª¤æ“ä½œå‹å¹³å°

**æ“ä½œæµç¨‹ï¼š** æ‰“å¼€é¦–é¡µ â†’ ç‚¹å‡»"å‘å¸ƒ"æŒ‰é’® â†’ ä¸Šä¼ æ–‡ä»¶ â†’ è‡ªåŠ¨è·³è½¬åˆ°ç¼–è¾‘é¡µé¢ â†’ æ³¨å…¥å†…å®¹

**ä»£è¡¨å¹³å°ï¼š**
- å°çº¢ä¹¦ (xiaohongshu)
- æŠ–éŸ³ (douyin)

**æŠ€æœ¯ç‰¹å¾ï¼š**
- éœ€è¦æ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»æ“ä½œè¿›å…¥å‘å¸ƒæµç¨‹
- å…ˆä¸Šä¼ æ–‡ä»¶ï¼Œåæ³¨å…¥æ–‡æœ¬å†…å®¹
- æ¶‰åŠé¡µé¢è·³è½¬å’ŒçŠ¶æ€å˜åŒ–
- ä½¿ç”¨å¤æ‚çš„çŠ¶æ€ç®¡ç†æœºåˆ¶

### è·¨æ ‡ç­¾é¡µç‰¹æ®Šå¹³å°

**æ“ä½œæµç¨‹ï¼š** é¦–é¡µç‚¹å‡»æŒ‰é’® â†’ æ–°æ ‡ç­¾é¡µæ‰“å¼€ç¼–è¾‘å™¨ â†’ è·¨æ ‡ç­¾é¡µæ•°æ®ä¼ é€’ â†’ å†…å®¹æ³¨å…¥

**ä»£è¡¨å¹³å°ï¼š**
- å¾®ä¿¡å…¬ä¼—å· (weixin)

**æŠ€æœ¯ç‰¹å¾ï¼š**
- ä½¿ç”¨Background Scriptåè°ƒå¤šæ ‡ç­¾é¡µ
- æ•°æ®é€šè¿‡chrome.storageä¼ é€’
- ä¸ä½¿ç”¨ä¼ ç»Ÿé€‚é…å™¨æ¨¡å¼
- éœ€è¦ç‰¹æ®Šçš„è·¨æ ‡ç­¾é¡µé€šä¿¡æœºåˆ¶

## ğŸ”§ ç»Ÿä¸€åŸºç±»æ¶æ„

### æ¶æ„æ–‡ä»¶ç»“æ„

```
content-scripts/
â”œâ”€â”€ shared/                     # å…±äº«åŸºç±»å’Œå·¥å…·
â”‚   â”œâ”€â”€ PlatformAdapter.js     # æ ¸å¿ƒé€‚é…å™¨åŸºç±»
â”‚   â”œâ”€â”€ PlatformConfigBase.js  # é…ç½®ç®¡ç†åŸºç±»
â”‚   â””â”€â”€ AdapterInitializer.js  # é€‚é…å™¨åˆå§‹åŒ–å·¥å…·
â”œâ”€â”€ adapters/                   # å¹³å°é€‚é…å™¨å®ç°
â”‚   â”œâ”€â”€ common/                # å…±äº«åŸºç±»
â”‚   â”‚   â”œâ”€â”€ BaseClassLoader.js # åŸºç±»åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ BaseConfigManager.js # åŸºç¡€é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ MutationObserverBase.js # DOMç›‘å¬åŸºç±»
â”‚   â”œâ”€â”€ weibo.js               # å¾®åšé€‚é…å™¨
â”‚   â”œâ”€â”€ jike.js                # å³åˆ»é€‚é…å™¨
â”‚   â”œâ”€â”€ x.js                   # Xå¹³å°é€‚é…å™¨
â”‚   â”œâ”€â”€ bilibili.js            # Bilibilié€‚é…å™¨
â”‚   â”œâ”€â”€ weixinchannels.js      # å¾®ä¿¡è§†é¢‘å·é€‚é…å™¨
â”‚   â”œâ”€â”€ xiaohongshu.js         # å°çº¢ä¹¦é€‚é…å™¨
â”‚   â”œâ”€â”€ douyin.js              # æŠ–éŸ³é€‚é…å™¨
â”‚   â”œâ”€â”€ weixin-home.js         # å¾®ä¿¡å…¬ä¼—å·é¦–é¡µ
â”‚   â””â”€â”€ weixin-edit.js         # å¾®ä¿¡å…¬ä¼—å·ç¼–è¾‘é¡µ
â””â”€â”€ enhanced/                   # å¢å¼ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
```

### PlatformAdapter åŸºç±»

æ‰€æœ‰Aç±»å’ŒBç±»å¹³å°çš„æ ¸å¿ƒåŸºç±»ï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£å’Œé€šç”¨åŠŸèƒ½ã€‚

**æ–‡ä»¶ä½ç½®**: `content-scripts/shared/PlatformAdapter.js`

```javascript
class PlatformAdapter {
  constructor(platformId) {
    this.platformId = platformId;
    this.isInitialized = false;
  }

  // æŠ½è±¡æ–¹æ³• - å­ç±»å¿…é¡»å®ç°
  async publishContent(data) {
    throw new Error('å­ç±»å¿…é¡»å®ç° publishContent æ–¹æ³•');
  }

  // ç»Ÿä¸€çš„å…ƒç´ æŸ¥æ‰¾æ–¹æ³• - å­ç±»å¯é‡å†™
  findTitleInput() {
    return document.querySelector('input[placeholder*="æ ‡é¢˜"]');
  }

  findFileInput() {
    return document.querySelector('input[type="file"]');
  }

  findContentArea() {
    return document.querySelector('.input-editor, [contenteditable="true"]');
  }

  // ç»Ÿä¸€çš„å†…å®¹æ³¨å…¥æ–¹æ³•
  async injectTitle(title) {
    // ç»Ÿä¸€çš„æ ‡é¢˜æ³¨å…¥é€»è¾‘
  }

  async injectContent(content) {
    // ç»Ÿä¸€çš„å†…å®¹æ³¨å…¥é€»è¾‘
  }

  async uploadFiles(data) {
    // ç»Ÿä¸€çš„æ–‡ä»¶ä¸Šä¼ é€»è¾‘
  }
}
```

### PlatformConfigBase é…ç½®åŸºç±»

æä¾›ç»Ÿä¸€çš„é…ç½®ç®¡ç†æœºåˆ¶ï¼Œæ¶ˆé™¤å„å¹³å°é…ç½®ç®¡ç†å™¨ä¸­çš„é‡å¤ä»£ç ã€‚

**æ–‡ä»¶ä½ç½®**: `content-scripts/shared/PlatformConfigBase.js`

```javascript
class PlatformConfigBase extends BaseConfigManager {
  constructor(platform) {
    super(platform);
    this.platform = platform;
  }

  /**
   * ç»Ÿä¸€çš„é…ç½®åŠ è½½æ¨¡å¼
   * @param {Object} platformSpecificConfig - å¹³å°ç‰¹å®šé…ç½®
   * @returns {Object} åˆå¹¶åçš„é…ç½®å¯¹è±¡
   */
  loadPlatformConfig(platformSpecificConfig) {
    const baseConfig = super.loadConfig();
    return this.mergeConfig(baseConfig, platformSpecificConfig);
  }

  /**
   * åˆ›å»ºæ ‡å‡†çš„å»¶è¿Ÿé…ç½®
   * @param {Object} overrides - è¦†ç›–çš„å»¶è¿Ÿé…ç½®
   * @returns {Object} å»¶è¿Ÿé…ç½®å¯¹è±¡
   */
  createDelayConfig(overrides = {}) {
    const defaultDelays = {
      FAST_CHECK: 100,
      NORMAL_WAIT: 300,
      UPLOAD_WAIT: 1000,
      ELEMENT_WAIT: 2000
    };
    return { ...defaultDelays, ...overrides };
  }

  /**
   * åˆ›å»ºæ ‡å‡†çš„é™åˆ¶é…ç½®
   * @param {Object} overrides - è¦†ç›–çš„é™åˆ¶é…ç½®
   * @returns {Object} é™åˆ¶é…ç½®å¯¹è±¡
   */
  createLimitsConfig(overrides = {}) {
    const defaultLimits = {
      maxContentLength: 2000,
      maxTitleLength: 100,
      maxMediaFiles: 9,
      allowedImageTypes: ['image/jpeg', 'image/png', 'image/gif'],
      maxFileSize: 10 * 1024 * 1024 // 10MB
    };
    return { ...defaultLimits, ...overrides };
  }
}
```

### MutationObserverBase ç›‘å¬åŸºç±»

æä¾›ç»Ÿä¸€çš„DOMå˜åŒ–ç›‘å¬æœºåˆ¶ï¼Œç”¨äºæ£€æµ‹é¡µé¢å…ƒç´ çš„åŠ è½½çŠ¶æ€ã€‚

**æ–‡ä»¶ä½ç½®**: `content-scripts/adapters/common/MutationObserverBase.js`

```javascript
class MutationObserverBase {
  constructor(platformId) {
    this.platformId = platformId;
    this.observer = null;
    this.isObserving = false;
  }

  /**
   * å¯åŠ¨DOMç›‘å¬
   * @param {Function} callback - å…ƒç´ å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°
   */
  startObserving(callback) {
    if (this.isObserving) return;

    this.observer = new MutationObserver((mutations) => {
      const checkResult = this.checkElements();
      if (checkResult.ready && callback) {
        callback(checkResult);
      }
    });

    this.observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true
    });

    this.isObserving = true;
  }

  /**
   * åœæ­¢DOMç›‘å¬
   */
  stopObserving() {
    if (this.observer) {
      this.observer.disconnect();
      this.observer = null;
      this.isObserving = false;
    }
  }

  /**
   * æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å°±ç»ª - å­ç±»å¿…é¡»å®ç°
   * @returns {Object} { ready: boolean, reason?: string, elements?: Object }
   */
  checkElements() {
    throw new Error('å­ç±»å¿…é¡»å®ç° checkElements æ–¹æ³•');
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºç›®æ ‡é¡µé¢ - å­ç±»å¿…é¡»å®ç°
   * @returns {boolean}
   */
  isTargetPage() {
    throw new Error('å­ç±»å¿…é¡»å®ç° isTargetPage æ–¹æ³•');
  }
}
```

### AdapterInitializer åˆå§‹åŒ–å·¥å…·

ç»Ÿä¸€å¤„ç†é€‚é…å™¨çš„ä¾èµ–æ£€æŸ¥ã€åˆå§‹åŒ–å’Œæ¶ˆæ¯ç›‘å¬é€»è¾‘ï¼Œæ¶ˆé™¤é‡å¤ä»£ç ã€‚

**æ–‡ä»¶ä½ç½®**: `content-scripts/shared/AdapterInitializer.js`

```javascript
class AdapterInitializer {
  static initializedPlatforms = new Set();
  static messageListeners = new Map();

  /**
   * åˆå§‹åŒ–å¹³å°é€‚é…å™¨
   * @param {string} platform - å¹³å°åç§°
   * @param {string} adapterClassName - é€‚é…å™¨ç±»å
   * @param {Function} legacyInitializer - æ—§ç‰ˆæœ¬åˆå§‹åŒ–å‡½æ•°
   */
  static async initialize(platform, adapterClassName, legacyInitializer) {
    const initKey = `${platform}-${adapterClassName}`;
    if (this.initializedPlatforms.has(initKey)) {
      console.log(`${platform}é€‚é…å™¨å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–`);
      return;
    }

    this.initializedPlatforms.add(initKey);

    try {
      const dependencyType = await this.waitForDependencies(platform, adapterClassName);

      if (dependencyType === 'new') {
        this.initializeNewAdapter(platform, adapterClassName);
      } else if (legacyInitializer) {
        legacyInitializer();
      }
    } catch (error) {
      console.error(`${platform}é€‚é…å™¨åˆå§‹åŒ–å¤±è´¥:`, error);
      if (legacyInitializer) {
        legacyInitializer();
      }
    }
  }

  /**
   * ç­‰å¾…ä¾èµ–åŠ è½½
   */
  static async waitForDependencies(platform, adapterClassName) {
    // æ£€æŸ¥æ–°æŠ€æœ¯æ–¹æ¡ˆçš„ä¾èµ–
    if (window.PlatformAdapter && window.PlatformConfigBase && window[adapterClassName]) {
      return 'new';
    }

    // ç­‰å¾…ä¾èµ–åŠ è½½
    const maxAttempts = 50;
    for (let attempts = 0; attempts < maxAttempts; attempts++) {
      if (window.PlatformAdapter && window.PlatformConfigBase && window[adapterClassName]) {
        return 'new';
      }
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    return 'legacy';
  }
}
```

## ğŸ¯ Aç±»å¹³å°å®ç°è¯¦è§£

### å®ç°æ¨¡å¼

Aç±»å¹³å°ä½¿ç”¨**ç›´æ¥æ³¨å…¥æ¨¡å¼**ï¼Œæ“ä½œæµç¨‹ç®€å•ç›´æ¥ï¼š

```
æ‰“å¼€é¡µé¢ â†’ ç­‰å¾…å…ƒç´ åŠ è½½ â†’ æ³¨å…¥æ ‡é¢˜ â†’ ä¸Šä¼ æ–‡ä»¶ â†’ æ³¨å…¥å†…å®¹ â†’ å‘å¸ƒå®Œæˆ
```

### æ ‡å‡†å®ç°æ¨¡æ¿

```javascript
class StandardPlatformAdapter extends PlatformAdapter {
  constructor() {
    super('platform-id');
    this.configManager = new PlatformConfigManager();
    this.config = this.configManager.loadConfig();
  }

  async publishContent(data) {
    try {
      // ç­‰å¾…é¡µé¢åŠ è½½
      await this.waitForElements();

      // æŒ‰é¡ºåºæ‰§è¡Œå‘å¸ƒæ­¥éª¤
      if (data.title) await this.injectTitle(data.title);
      if (data.files?.length) await this.uploadFiles(data);
      if (data.content) await this.injectContent(data.content);

      return { success: true, message: 'å‘å¸ƒæˆåŠŸ' };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
}
```

### å¾®ä¿¡è§†é¢‘å·ç‰¹æ®Šå®ç°

å¾®ä¿¡è§†é¢‘å·ä½œä¸ºAç±»å¹³å°çš„ç‰¹æ®Šå®ç°ï¼Œéœ€è¦å¤„ç†Shadow DOMå’Œç‚¹å‡»æ¿€æ´»ï¼š

```javascript
class WeixinChannelsPlatformAdapter extends PlatformAdapter {
  // é‡å†™å…ƒç´ æŸ¥æ‰¾æ–¹æ³• - æ”¯æŒShadow DOM
  findTitleInput() {
    return this.findElementInShadow(this.config.selectors.titleInput);
  }

  // é‡å†™æ¿€æ´»æ–¹æ³• - æ”¯æŒç‚¹å‡»æ¿€æ´»
  async activateEditingArea() {
    const shadowRoot = this.getShadowRoot();
    const triggerElement = Array.from(shadowRoot.querySelectorAll('*'))
      .find(el => el.textContent?.includes('æ·»åŠ æè¿°'));

    if (triggerElement) {
      triggerElement.click();
      await this.delay(this.config.delays.NORMAL_WAIT);
    }
    return true;
  }

  // Shadow DOMå¤„ç†æ–¹æ³•
  getShadowRoot() {
    const wujieApp = document.querySelector('wujie-app');
    return wujieApp?.shadowRoot || null;
  }

  findElementInShadow(selector, fallbackSelectors = []) {
    const shadowRoot = this.getShadowRoot();
    if (!shadowRoot) return null;

    let element = shadowRoot.querySelector(selector);
    if (element) return element;

    for (const fallbackSelector of fallbackSelectors) {
      element = shadowRoot.querySelector(fallbackSelector);
      if (element) return element;
    }
    return null;
  }
}
```

## ğŸ”„ Bç±»å¹³å°å®ç°è¯¦è§£

### å®ç°æ¨¡å¼

Bç±»å¹³å°ä½¿ç”¨**å¤šæ­¥éª¤æ“ä½œæ¨¡å¼**ï¼Œéœ€è¦æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’ï¼š

```
æ‰“å¼€é¦–é¡µ â†’ ç‚¹å‡»å‘å¸ƒæŒ‰é’® â†’ ä¸Šä¼ æ–‡ä»¶ â†’ ç­‰å¾…é¡µé¢è·³è½¬ â†’ æ³¨å…¥æ ‡é¢˜å’Œå†…å®¹ â†’ å‘å¸ƒå®Œæˆ
```

### çŠ¶æ€ç®¡ç†æœºåˆ¶

```javascript
class MultiStepPlatformAdapter extends PlatformAdapter {
  constructor() {
    super('platform-id');
    this.currentStep = 'initial';
    this.stateManager = new StateManager();
  }

  async publishContent(data) {
    try {
      await this.executeStep('clickPublishButton');
      await this.executeStep('uploadFiles', data.files);
      await this.executeStep('waitForNavigation');
      await this.executeStep('injectContent', data);

      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  async executeStep(stepName, stepData = null) {
    switch (stepName) {
      case 'clickPublishButton':
        return await this.clickPublishButton();
      case 'uploadFiles':
        return await this.uploadFiles(stepData);
      case 'waitForNavigation':
        return await this.waitForNavigation();
      case 'injectContent':
        return await this.injectContentAfterNavigation(stepData);
    }
  }
}
```

## ğŸ”— è·¨æ ‡ç­¾é¡µå¹³å°å®ç°

### å®ç°æ¶æ„

è·¨æ ‡ç­¾é¡µå¹³å°ä½¿ç”¨Background Scriptåè°ƒå¤šä¸ªæ ‡ç­¾é¡µï¼š

```
ä¸»é¡µé¢ â†’ Background Script â†’ æ–°æ ‡ç­¾é¡µ
         â†“
      æ•°æ®å­˜å‚¨ â†’ å†…å®¹æ³¨å…¥
```

### é€šä¿¡æœºåˆ¶

```javascript
// Background Script
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === 'openNewTab') {
    chrome.tabs.create({
      url: message.url,
      active: true
    }, (tab) => {
      // å­˜å‚¨æ•°æ®ä¾›æ–°æ ‡ç­¾é¡µä½¿ç”¨
      chrome.storage.local.set({
        [`publishData_${tab.id}`]: message.data
      });
    });
  }
});

// Content Script (æ–°æ ‡ç­¾é¡µ)
chrome.storage.local.get([`publishData_${tabId}`], (result) => {
  const publishData = result[`publishData_${tabId}`];
  if (publishData) {
    // æ‰§è¡Œå†…å®¹æ³¨å…¥
    injectContent(publishData);
  }
});
```

## ğŸ“‹ é…ç½®ç®¡ç†ä½“ç³»

### å¹³å°é…ç½®ç»“æ„

```javascript
// shared/config/platforms.js
const SUPPORTED_PLATFORMS = [
  {
    id: 'weixinchannels',
    name: 'å¾®ä¿¡è§†é¢‘å·',
    publishUrl: 'https://channels.weixin.qq.com/platform/post/finderNewLifeCreate',
    color: 'bg-green-500',
    logoUrl: 'https://favicon.im/channels.weixin.qq.com',
    domain: 'channels.weixin.qq.com',
    // å¹³å°åˆ†ç±»æ ‡è¯†
    platformType: 'direct-injection',
    // ç‰¹æ®ŠæŠ€æœ¯ç‰¹å¾
    specialFeatures: {
      shadowDOMAccess: true,
      requiresActivation: true
    }
  }
];
```

### é€‚é…å™¨é…ç½®ç®¡ç†

```javascript
class WeixinChannelsConfigManager extends PlatformConfigBase {
  loadConfig() {
    return {
      delays: this.createDelayConfig({
        FAST_CHECK: 200,
        NORMAL_WAIT: 500,
        UPLOAD_WAIT: 1500,
        ELEMENT_WAIT: 3000
      }),
      limits: this.createLimitsConfig({
        maxContentLength: 1000,
        maxTitleLength: 22,
        maxMediaFiles: 18,
        allowedImageTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
        maxFileSize: 20 * 1024 * 1024
      }),
      selectors: {
        shadowHost: 'wujie-app',
        titleInput: 'input[placeholder="å¡«å†™æ ‡é¢˜, 22ä¸ªå­—ç¬¦å†…"]',
        contentArea: '.input-editor',
        fileInput: 'input[type="file"][accept="image/*"]'
      }
    };
  }
}
```

## ğŸ­ å·¥å‚æ¨¡å¼é›†æˆ

### PlatformAdapterFactory

ç»Ÿä¸€çš„å¹³å°é€‚é…å™¨å·¥å‚ï¼Œè´Ÿè´£åˆ›å»ºå’Œç®¡ç†æ‰€æœ‰å¹³å°é€‚é…å™¨å®ä¾‹ã€‚

**æ–‡ä»¶ä½ç½®**: `content-scripts/shared/PlatformAdapter.js`

```javascript
class PlatformAdapterFactory {
  /**
   * åˆ›å»ºå¹³å°é€‚é…å™¨å®ä¾‹
   * @param {string} platform - å¹³å°æ ‡è¯†ç¬¦
   * @returns {PlatformAdapter} é€‚é…å™¨å®ä¾‹
   */
  static create(platform) {
    // Aç±»æ ‡å‡†å¹³å°
    if (platform === 'jike') {
      if (window.JikeAdapter) {
        return new window.JikeAdapter();
      } else {
        throw new Error('å³åˆ»é€‚é…å™¨æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ jike.js å·²æ­£ç¡®åŠ è½½');
      }
    }

    if (platform === 'weibo') {
      if (window.WeiboAdapter) {
        return new window.WeiboAdapter();
      } else {
        throw new Error('å¾®åšé€‚é…å™¨æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ weibo.js å·²æ­£ç¡®åŠ è½½');
      }
    }

    if (platform === 'x') {
      if (window.XAdapter) {
        return new window.XAdapter();
      } else {
        throw new Error('Xå¹³å°é€‚é…å™¨æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ x.js å·²æ­£ç¡®åŠ è½½');
      }
    }

    if (platform === 'bilibili') {
      if (window.BilibiliAdapter) {
        return new window.BilibiliAdapter();
      } else {
        throw new Error('Bilibilié€‚é…å™¨æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ bilibili.js å·²æ­£ç¡®åŠ è½½');
      }
    }

    // Aç±»ç‰¹æ®Šå¹³å°ï¼ˆShadow DOMå¤„ç†ï¼‰
    if (platform === 'weixinchannels') {
      if (window.WeixinChannelsPlatformAdapter) {
        return new window.WeixinChannelsPlatformAdapter();
      } else {
        throw new Error('å¾®ä¿¡è§†é¢‘å·é€‚é…å™¨æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ weixinchannels.js å·²æ­£ç¡®åŠ è½½');
      }
    }

    // Bç±»å¹³å°ï¼ˆå¤šæ­¥éª¤æ“ä½œï¼‰
    if (platform === 'douyin') {
      if (window.DouyinAdapter) {
        return new window.DouyinAdapter();
      } else {
        throw new Error('æŠ–éŸ³é€‚é…å™¨æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ douyin.js å·²æ­£ç¡®åŠ è½½');
      }
    }

    if (platform === 'xiaohongshu') {
      if (window.XiaohongshuAdapter) {
        return new window.XiaohongshuAdapter();
      } else {
        throw new Error('å°çº¢ä¹¦é€‚é…å™¨æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ xiaohongshu.js å·²æ­£ç¡®åŠ è½½');
      }
    }

    // è·¨æ ‡ç­¾é¡µå¹³å°
    if (platform === 'weixin') {
      throw new Error('å¾®ä¿¡å…¬ä¼—å·å¹³å°ä½¿ç”¨è·¨æ ‡ç­¾é¡µæœºåˆ¶ï¼Œè¯·é€šè¿‡Background Scriptå¤„ç†');
    }

    throw new Error(`ä¸æ”¯æŒçš„å¹³å°: ${platform}`);
  }

  /**
   * è·å–æ‰€æœ‰æ”¯æŒçš„å¹³å°åˆ—è¡¨
   * @returns {string[]} å¹³å°æ ‡è¯†ç¬¦æ•°ç»„
   */
  static getSupportedPlatforms() {
    return ['jike', 'weibo', 'douyin', 'xiaohongshu', 'x', 'bilibili', 'weixinchannels', 'weixin'];
  }

  /**
   * æ£€æŸ¥å¹³å°æ˜¯å¦æ”¯æŒ
   * @param {string} platform - å¹³å°æ ‡è¯†ç¬¦
   * @returns {boolean} æ˜¯å¦æ”¯æŒ
   */
  static isSupported(platform) {
    return this.getSupportedPlatforms().includes(platform);
  }

  /**
   * è·å–å¹³å°åˆ†ç±»ä¿¡æ¯
   * @param {string} platform - å¹³å°æ ‡è¯†ç¬¦
   * @returns {Object} å¹³å°åˆ†ç±»ä¿¡æ¯
   */
  static getPlatformType(platform) {
    const platformTypes = {
      // Aç±»æ ‡å‡†å¹³å°
      'jike': { type: 'A', subtype: 'standard', description: 'ç›´æ¥æ³¨å…¥å‹' },
      'weibo': { type: 'A', subtype: 'standard', description: 'ç›´æ¥æ³¨å…¥å‹' },
      'x': { type: 'A', subtype: 'standard', description: 'ç›´æ¥æ³¨å…¥å‹' },
      'bilibili': { type: 'A', subtype: 'standard', description: 'ç›´æ¥æ³¨å…¥å‹' },

      // Aç±»ç‰¹æ®Šå¹³å°
      'weixinchannels': { type: 'A', subtype: 'special', description: 'ç›´æ¥æ³¨å…¥å‹ï¼ˆShadow DOMï¼‰' },

      // Bç±»å¹³å°
      'douyin': { type: 'B', subtype: 'multi-step', description: 'å¤šæ­¥éª¤æ“ä½œå‹' },
      'xiaohongshu': { type: 'B', subtype: 'multi-step', description: 'å¤šæ­¥éª¤æ“ä½œå‹' },

      // è·¨æ ‡ç­¾é¡µå¹³å°
      'weixin': { type: 'CrossTab', subtype: 'cross-tab', description: 'è·¨æ ‡ç­¾é¡µé€šä¿¡å‹' }
    };

    return platformTypes[platform] || { type: 'Unknown', subtype: 'unknown', description: 'æœªçŸ¥ç±»å‹' };
  }
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ç»Ÿä¸€æŠ½è±¡å±‚ä¼˜åŒ–

```javascript
// ä¼˜åŒ–å‰ï¼šé‡å¤çš„äº‹ä»¶è§¦å‘ä»£ç 
titleInput.dispatchEvent(new Event('input', { bubbles: true }));
titleInput.dispatchEvent(new Event('change', { bubbles: true }));

// ä¼˜åŒ–åï¼šç»Ÿä¸€çš„äº‹ä»¶è§¦å‘æ–¹æ³•
_triggerInputEvents(element) {
  const events = ['input', 'change'];
  events.forEach(eventType => {
    element.dispatchEvent(new Event(eventType, { bubbles: true }));
  });
}
```

### æ‰¹é‡å¤„ç†ä¼˜åŒ–

```javascript
// ä¼˜åŒ–å‰ï¼šé€ä¸ªå¤„ç†æ–‡ä»¶
for (const file of filesToUpload) {
  dataTransfer.items.add(file);
  this.log(`æ·»åŠ æ–‡ä»¶: ${file.name}`);
}

// ä¼˜åŒ–åï¼šæ‰¹é‡å¤„ç†æ–‡ä»¶
filesToUpload.forEach(file => dataTransfer.items.add(file));
this.log(`æ‰¹é‡æ·»åŠ  ${filesToUpload.length} ä¸ªæ–‡ä»¶`);
```

### æ€§èƒ½ç›‘æ§

```javascript
class PerformanceMonitor {
  static measureOperation(operationName, operation) {
    const startTime = performance.now();
    const result = await operation();
    const endTime = performance.now();

    console.log(`${operationName} æ‰§è¡Œæ—¶é—´: ${endTime - startTime}ms`);
    return result;
  }
}
```

---

## ğŸ“š æ–‡æ¡£æ›´æ–°è®°å½•

### v2.1 (2025-01-21)
- âœ… æ›´æ–°äº†å®é™…çš„æ–‡ä»¶ç»“æ„å’Œæ¶æ„ä¿¡æ¯
- âœ… å®Œå–„äº†PlatformConfigBaseå’ŒMutationObserverBaseåŸºç±»è¯´æ˜
- âœ… æ·»åŠ äº†AdapterInitializeråˆå§‹åŒ–å·¥å…·æ–‡æ¡£
- âœ… æ›´æ–°äº†å·¥å‚æ¨¡å¼é›†æˆçš„å®é™…å®ç°
- âœ… è¡¥å……äº†å¹³å°åˆ†ç±»å’Œç±»å‹æ£€æŸ¥åŠŸèƒ½
- âœ… ä¸å®é™…ä»£ç ç»“æ„ä¿æŒ100%ä¸€è‡´

### v2.0 (2025-01-08)
- åˆå§‹ç‰ˆæœ¬ï¼Œå»ºç«‹äº†å®Œæ•´çš„å¹³å°æ¶æ„ä½“ç³»
- å®šä¹‰äº†Aç±»ã€Bç±»ã€è·¨æ ‡ç­¾é¡µä¸‰å¤§å¹³å°åˆ†ç±»
- å»ºç«‹äº†ç»Ÿä¸€åŸºç±»æ¶æ„è®¾è®¡

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.1
**æœ€åæ›´æ–°ï¼š** 2025-01-21
**ç»´æŠ¤è€…ï¼š** MomentDots å¼€å‘å›¢é˜Ÿ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- **æ¶æ„é—®é¢˜**: åœ¨é¡¹ç›®ä»“åº“æäº¤Issueå¹¶æ ‡è®°ä¸º`architecture`
- **å¼€å‘æŒ‡å¯¼**: å‚è€ƒ[æ–°å¹³å°å¼€å‘æŒ‡å—](./new-platform-development-guide.md)
- **ä»£ç ç¤ºä¾‹**: æŸ¥çœ‹`content-scripts/adapters/`ç›®å½•ä¸‹çš„å®é™…å®ç°
- **ç´§æ€¥é—®é¢˜**: è”ç³»æ¶æ„è´Ÿè´£äºº

> ğŸ’¡ **æç¤º**: æœ¬æ–‡æ¡£ä¸å®é™…ä»£ç ç»“æ„ä¿æŒåŒæ­¥æ›´æ–°ï¼Œå»ºè®®å¼€å‘æ—¶å¯¹ç…§å®é™…ä»£ç æ–‡ä»¶è¿›è¡Œç†è§£ã€‚
