<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯åŠ©æ‰‹å®Œæ•´åŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="../prompt/sidepanel.css">
    <link rel="stylesheet" href="../prompt/components/modal.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 400px;
            height: 600px;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .test-header {
            background: #f0f0f0;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }
        .test-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            max-width: 150px;
            word-wrap: break-word;
        }
        .test-content {
            height: calc(100vh - 50px);
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="test-header">æç¤ºè¯åŠ©æ‰‹åŠŸèƒ½æµ‹è¯•</div>
    <div class="test-status" id="testStatus">åˆå§‹åŒ–ä¸­...</div>
    
    <div class="test-content">
        <div class="prompt-container">
            <!-- é¡¶éƒ¨åˆ†ç±»å¯¼èˆªæ  -->
            <div class="prompt-category-nav">
                <div class="prompt-category-tabs" id="promptCategoryTabs">
                    <!-- åˆ†ç±»æ ‡ç­¾å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button class="prompt-add-btn" id="promptAddBtn" title="æ·»åŠ æç¤ºè¯">+</button>
            </div>

            <!-- æç¤ºè¯å¡ç‰‡åˆ—è¡¨ -->
            <div class="prompt-list" id="promptList">
                <!-- æç¤ºè¯å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- åº•éƒ¨æ“ä½œåŒº -->
            <div class="prompt-bottom-actions">
                <div class="prompt-action-row">
                    <button class="prompt-action-btn-large" id="promptExportBtn" title="å¯¼å‡ºæ•°æ®">
                        <span class="icon">ğŸ“¤</span>
                        å¯¼å‡º
                    </button>
                    <button class="prompt-action-btn-large" id="promptImportBtn" title="å¯¼å…¥æ•°æ®">
                        <span class="icon">ğŸ“¥</span>
                        å¯¼å…¥
                    </button>
                    <button class="prompt-settings-btn" id="promptSettingsBtn">
                        <span class="icon">âš™ï¸</span>
                    </button>
                </div>
                <input type="file" id="promptImportFile" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <!-- æç¤ºè¯ç¼–è¾‘å¼¹çª— -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="promptModalTitle">æ·»åŠ æç¤ºè¯</h3>
                <button class="modal-close" id="promptCloseModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="promptForm">
                    <div class="form-group">
                        <label for="promptName">æç¤ºè¯åç§°</label>
                        <input type="text" id="promptName" required>
                    </div>
                    <div class="form-group">
                        <label for="promptCategory">åˆ†ç±»</label>
                        <select id="promptCategory">
                            <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                            <option value="åˆ›æ„è®¾è®¡">åˆ›æ„è®¾è®¡</option>
                            <option value="å†…å®¹å¯è§†åŒ–">å†…å®¹å¯è§†åŒ–</option>
                            <option value="å­¦ä¹ æå‡">å­¦ä¹ æå‡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="promptContent">æç¤ºè¯å†…å®¹</label>
                        <textarea id="promptContent" rows="6" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="promptModel">AIæ¨¡å‹</label>
                        <select id="promptModel">
                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="promptCancelBtn">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="promptSaveBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- AIæ”¹å†™å¼¹çª— -->
    <div id="promptRewriteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>AIæ–‡æ¡ˆæ”¹å†™</h3>
                <button class="modal-close" id="promptCloseRewriteBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="promptOriginalText">åŸå§‹æ–‡æœ¬</label>
                    <textarea id="promptOriginalText" rows="4" placeholder="è¯·è¾“å…¥è¦æ”¹å†™çš„æ–‡æœ¬"></textarea>
                </div>
                <div class="form-group">
                    <label for="promptRewriteResult">æ”¹å†™ç»“æœ</label>
                    <textarea id="promptRewriteResult" rows="6" readonly></textarea>
                </div>
                <div class="rewrite-actions">
                    <button type="button" class="btn btn-primary" id="promptStartRewriteBtn">å¼€å§‹æ”¹å†™</button>
                    <button type="button" class="btn btn-secondary" id="promptCopyResultBtn">å¤åˆ¶ç»“æœ</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="promptCancelRewriteBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="promptSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è®¾ç½®</h3>
                <button class="modal-close" id="promptCloseSettingsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="promptApiKey">API Key</label>
                    <input type="password" id="promptApiKey" placeholder="è¯·è¾“å…¥Google AI API Key">
                </div>
                <div class="form-group">
                    <label for="promptApiEndpoint">APIç«¯ç‚¹</label>
                    <input type="url" id="promptApiEndpoint" placeholder="APIç«¯ç‚¹URL">
                </div>
                <div class="form-group">
                    <label for="promptDefaultModel">é»˜è®¤æ¨¡å‹</label>
                    <select id="promptDefaultModel">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="promptCancelSettingsBtn">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="promptSaveSettingsBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å®Œæ•´çš„Chrome APIæ¨¡æ‹Ÿ -->
    <script>
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateTestStatus(message) {
            const status = document.getElementById('testStatus');
            if (status) {
                status.textContent = message;
            }
            console.log('æµ‹è¯•çŠ¶æ€:', message);
        }

        // å®Œæ•´çš„Chromeæ‰©å±•APIæ¨¡æ‹Ÿ
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        data: {
                            // é¢„è®¾æµ‹è¯•æ•°æ®
                            promptCategories: ['å…¨éƒ¨', 'åˆ›æ„è®¾è®¡', 'å†…å®¹å¯è§†åŒ–', 'å­¦ä¹ æå‡'],
                            promptPrompts: [
                                {
                                    id: 'prompt_test_1',
                                    name: 'è®ºæ–‡å¤§å¸ˆæç¤ºè¯',
                                    content: 'ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å­¦æœ¯å†™ä½œä¸“å®¶ï¼Œè¯·å¸®æˆ‘æ”¹å†™ä»¥ä¸‹å†…å®¹ï¼Œä½¿å…¶æ›´åŠ å­¦æœ¯åŒ–ã€ä¸¥è°¨ä¸”ç¬¦åˆè®ºæ–‡å†™ä½œè§„èŒƒã€‚è¦æ±‚ï¼š1. ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ 2. é€»è¾‘æ¸…æ™° 3. è¡¨è¾¾å‡†ç¡®',
                                    category: 'å­¦ä¹ æå‡',
                                    model: 'gemini-2.5-flash'
                                },
                                {
                                    id: 'prompt_test_2',
                                    name: 'å¾®ä¿¡è¡¨æƒ…åŒ…æç¤ºè¯',
                                    content: 'è¯·å°†ä»¥ä¸‹æ–‡å­—è½¬æ¢ä¸ºé€‚åˆå¾®ä¿¡èŠå¤©çš„è¡¨æƒ…åŒ…æ–‡æ¡ˆï¼Œè¦æ±‚ç”ŸåŠ¨æœ‰è¶£ã€æœ—æœ—ä¸Šå£ï¼Œç¬¦åˆç½‘ç»œæµè¡Œè¯­ç‰¹ç‚¹ã€‚',
                                    category: 'åˆ›æ„è®¾è®¡',
                                    model: 'gemini-2.5-flash'
                                },
                                {
                                    id: 'prompt_test_3',
                                    name: 'æ•°æ®å¯è§†åŒ–åŠ©æ‰‹',
                                    content: 'ä½œä¸ºæ•°æ®å¯è§†åŒ–ä¸“å®¶ï¼Œè¯·å¸®æˆ‘åˆ†æä»¥ä¸‹æ•°æ®å¹¶æä¾›å¯è§†åŒ–å»ºè®®ï¼ŒåŒ…æ‹¬å›¾è¡¨ç±»å‹é€‰æ‹©ã€é¢œè‰²æ­é…ã€å¸ƒå±€è®¾è®¡ç­‰ã€‚',
                                    category: 'å†…å®¹å¯è§†åŒ–',
                                    model: 'gemini-2.5-flash'
                                }
                            ],
                            promptSettings: {
                                models: [
                                    {
                                        id: 'gemini-2.5-flash',
                                        name: 'Gemini 2.5 Flash',
                                        apiKey: 'test-api-key',
                                        endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent'
                                    }
                                ],
                                defaultModel: 'gemini-2.5-flash'
                            }
                        },
                        get: function(keys) {
                            return new Promise((resolve) => {
                                const result = {};
                                if (Array.isArray(keys)) {
                                    keys.forEach(key => {
                                        if (this.data[key] !== undefined) {
                                            result[key] = this.data[key];
                                        }
                                    });
                                } else if (typeof keys === 'string') {
                                    if (this.data[keys] !== undefined) {
                                        result[keys] = this.data[keys];
                                    }
                                } else if (typeof keys === 'object') {
                                    Object.keys(keys).forEach(key => {
                                        if (this.data[key] !== undefined) {
                                            result[key] = this.data[key];
                                        } else {
                                            result[key] = keys[key];
                                        }
                                    });
                                }
                                console.log('æ¨¡æ‹Ÿå­˜å‚¨ GET:', keys, '=>', result);
                                setTimeout(() => resolve(result), 10);
                            });
                        },
                        set: function(items) {
                            return new Promise((resolve) => {
                                Object.assign(this.data, items);
                                console.log('æ¨¡æ‹Ÿå­˜å‚¨ SET:', items);
                                setTimeout(() => resolve(), 10);
                            });
                        },
                        clear: function() {
                            return new Promise((resolve) => {
                                this.data = {};
                                console.log('æ¨¡æ‹Ÿå­˜å‚¨å·²æ¸…ç©º');
                                setTimeout(() => resolve(), 10);
                            });
                        }
                    }
                }
            };
            
            updateTestStatus('Chrome API æ¨¡æ‹Ÿå®Œæˆ');
        }

        // åŠ è½½æç¤ºè¯åŠ©æ‰‹è„šæœ¬
        function loadPromptScripts() {
            updateTestStatus('å¼€å§‹åŠ è½½è„šæœ¬...');

            const scripts = [
                '../prompt/components/api.js',
                '../prompt/components/modal.js',
                '../prompt/sidepanel.js'
            ];

            let loadedCount = 0;

            function loadNextScript(index) {
                if (index >= scripts.length) {
                    updateTestStatus('æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ');
                    // ç­‰å¾…ä¸€ä¸‹å†åˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½æ‰§è¡Œå®Œæ¯•
                    setTimeout(() => {
                        if (window.promptApp) {
                            updateTestStatus('åº”ç”¨åˆå§‹åŒ–æˆåŠŸ');
                            testBasicFunctionality();
                        } else {
                            updateTestStatus('ç­‰å¾…åº”ç”¨åˆå§‹åŒ–...');
                            setTimeout(() => {
                                if (window.promptApp) {
                                    updateTestStatus('åº”ç”¨åˆå§‹åŒ–æˆåŠŸ');
                                    testBasicFunctionality();
                                } else {
                                    updateTestStatus('åº”ç”¨åˆå§‹åŒ–å¤±è´¥');
                                }
                            }, 1000);
                        }
                    }, 500);
                    return;
                }

                const script = document.createElement('script');
                script.src = scripts[index];
                script.onload = () => {
                    loadedCount++;
                    updateTestStatus(`è„šæœ¬ ${loadedCount}/${scripts.length} åŠ è½½å®Œæˆ`);
                    loadNextScript(index + 1);
                };
                script.onerror = () => {
                    updateTestStatus(`è„šæœ¬ ${scripts[index]} åŠ è½½å¤±è´¥`);
                    loadNextScript(index + 1);
                };
                document.head.appendChild(script);
            }

            loadNextScript(0);
        }

        // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        function testBasicFunctionality() {
            updateTestStatus('æµ‹è¯•åŸºæœ¬åŠŸèƒ½...');

            // æµ‹è¯•æŒ‰é’®ç‚¹å‡»
            setTimeout(() => {
                const addBtn = document.getElementById('promptAddBtn');
                if (addBtn) {
                    updateTestStatus('âœ“ æ·»åŠ æŒ‰é’®å¯ç”¨');
                } else {
                    updateTestStatus('âœ— æ·»åŠ æŒ‰é’®ä¸å¯ç”¨');
                }

                // æµ‹è¯•åˆ†ç±»æ ‡ç­¾
                const categoryTabs = document.getElementById('promptCategoryTabs');
                if (categoryTabs && categoryTabs.children.length > 0) {
                    updateTestStatus('âœ“ åˆ†ç±»æ ‡ç­¾å·²æ¸²æŸ“');
                } else {
                    updateTestStatus('âœ— åˆ†ç±»æ ‡ç­¾æœªæ¸²æŸ“');
                }

                // æµ‹è¯•æç¤ºè¯åˆ—è¡¨
                const promptList = document.getElementById('promptList');
                if (promptList && promptList.children.length > 0) {
                    updateTestStatus('âœ“ æç¤ºè¯åˆ—è¡¨å·²æ¸²æŸ“');
                } else {
                    updateTestStatus('âœ— æç¤ºè¯åˆ—è¡¨æœªæ¸²æŸ“');
                }
            }, 1000);
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(loadPromptScripts, 100);
            });
        } else {
            setTimeout(loadPromptScripts, 100);
        }

        // é”™è¯¯ç›‘å¬
        window.addEventListener('error', (event) => {
            updateTestStatus('é”™è¯¯: ' + event.message);
            console.error('é¡µé¢é”™è¯¯:', event);
        });
    </script>
</body>
</html>
