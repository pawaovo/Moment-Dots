<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提示词助手完整功能测试</title>
    <link rel="stylesheet" href="../prompt/sidepanel.css">
    <link rel="stylesheet" href="../prompt/components/modal.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 400px;
            height: 600px;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .test-header {
            background: #f0f0f0;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }
        .test-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            max-width: 150px;
            word-wrap: break-word;
        }
        .test-content {
            height: calc(100vh - 50px);
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="test-header">提示词助手功能测试</div>
    <div class="test-status" id="testStatus">初始化中...</div>
    
    <div class="test-content">
        <div class="prompt-container">
            <!-- 顶部分类导航栏 -->
            <div class="prompt-category-nav">
                <div class="prompt-category-tabs" id="promptCategoryTabs">
                    <!-- 分类标签将通过JS动态生成 -->
                </div>
                <button class="prompt-add-btn" id="promptAddBtn" title="添加提示词">+</button>
            </div>

            <!-- 提示词卡片列表 -->
            <div class="prompt-list" id="promptList">
                <!-- 提示词卡片将通过JS动态生成 -->
            </div>

            <!-- 底部操作区 -->
            <div class="prompt-bottom-actions">
                <div class="prompt-action-row">
                    <button class="prompt-action-btn-large" id="promptExportBtn" title="导出数据">
                        <span class="icon">📤</span>
                        导出
                    </button>
                    <button class="prompt-action-btn-large" id="promptImportBtn" title="导入数据">
                        <span class="icon">📥</span>
                        导入
                    </button>
                    <button class="prompt-settings-btn" id="promptSettingsBtn">
                        <span class="icon">⚙️</span>
                    </button>
                </div>
                <input type="file" id="promptImportFile" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <!-- 提示词编辑弹窗 -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="promptModalTitle">添加提示词</h3>
                <button class="modal-close" id="promptCloseModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="promptForm">
                    <div class="form-group">
                        <label for="promptName">提示词名称</label>
                        <input type="text" id="promptName" required>
                    </div>
                    <div class="form-group">
                        <label for="promptCategory">分类</label>
                        <select id="promptCategory">
                            <option value="全部">全部</option>
                            <option value="创意设计">创意设计</option>
                            <option value="内容可视化">内容可视化</option>
                            <option value="学习提升">学习提升</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="promptContent">提示词内容</label>
                        <textarea id="promptContent" rows="6" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="promptModel">AI模型</label>
                        <select id="promptModel">
                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="promptCancelBtn">取消</button>
                <button type="button" class="btn btn-primary" id="promptSaveBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- AI改写弹窗 -->
    <div id="promptRewriteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>AI文案改写</h3>
                <button class="modal-close" id="promptCloseRewriteBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="promptOriginalText">原始文本</label>
                    <textarea id="promptOriginalText" rows="4" placeholder="请输入要改写的文本"></textarea>
                </div>
                <div class="form-group">
                    <label for="promptRewriteResult">改写结果</label>
                    <textarea id="promptRewriteResult" rows="6" readonly></textarea>
                </div>
                <div class="rewrite-actions">
                    <button type="button" class="btn btn-primary" id="promptStartRewriteBtn">开始改写</button>
                    <button type="button" class="btn btn-secondary" id="promptCopyResultBtn">复制结果</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="promptCancelRewriteBtn">关闭</button>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div id="promptSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>设置</h3>
                <button class="modal-close" id="promptCloseSettingsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="promptApiKey">API Key</label>
                    <input type="password" id="promptApiKey" placeholder="请输入Google AI API Key">
                </div>
                <div class="form-group">
                    <label for="promptApiEndpoint">API端点</label>
                    <input type="url" id="promptApiEndpoint" placeholder="API端点URL">
                </div>
                <div class="form-group">
                    <label for="promptDefaultModel">默认模型</label>
                    <select id="promptDefaultModel">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="promptCancelSettingsBtn">取消</button>
                <button type="button" class="btn btn-primary" id="promptSaveSettingsBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 完整的Chrome API模拟 -->
    <script>
        // 状态更新函数
        function updateTestStatus(message) {
            const status = document.getElementById('testStatus');
            if (status) {
                status.textContent = message;
            }
            console.log('测试状态:', message);
        }

        // 完整的Chrome扩展API模拟
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        data: {
                            // 预设测试数据
                            promptCategories: ['全部', '创意设计', '内容可视化', '学习提升'],
                            promptPrompts: [
                                {
                                    id: 'prompt_test_1',
                                    name: '论文大师提示词',
                                    content: '你是一位资深的学术写作专家，请帮我改写以下内容，使其更加学术化、严谨且符合论文写作规范。要求：1. 使用专业术语 2. 逻辑清晰 3. 表达准确',
                                    category: '学习提升',
                                    model: 'gemini-2.5-flash'
                                },
                                {
                                    id: 'prompt_test_2',
                                    name: '微信表情包提示词',
                                    content: '请将以下文字转换为适合微信聊天的表情包文案，要求生动有趣、朗朗上口，符合网络流行语特点。',
                                    category: '创意设计',
                                    model: 'gemini-2.5-flash'
                                },
                                {
                                    id: 'prompt_test_3',
                                    name: '数据可视化助手',
                                    content: '作为数据可视化专家，请帮我分析以下数据并提供可视化建议，包括图表类型选择、颜色搭配、布局设计等。',
                                    category: '内容可视化',
                                    model: 'gemini-2.5-flash'
                                }
                            ],
                            promptSettings: {
                                models: [
                                    {
                                        id: 'gemini-2.5-flash',
                                        name: 'Gemini 2.5 Flash',
                                        apiKey: 'test-api-key',
                                        endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent'
                                    }
                                ],
                                defaultModel: 'gemini-2.5-flash'
                            }
                        },
                        get: function(keys) {
                            return new Promise((resolve) => {
                                const result = {};
                                if (Array.isArray(keys)) {
                                    keys.forEach(key => {
                                        if (this.data[key] !== undefined) {
                                            result[key] = this.data[key];
                                        }
                                    });
                                } else if (typeof keys === 'string') {
                                    if (this.data[keys] !== undefined) {
                                        result[keys] = this.data[keys];
                                    }
                                } else if (typeof keys === 'object') {
                                    Object.keys(keys).forEach(key => {
                                        if (this.data[key] !== undefined) {
                                            result[key] = this.data[key];
                                        } else {
                                            result[key] = keys[key];
                                        }
                                    });
                                }
                                console.log('模拟存储 GET:', keys, '=>', result);
                                setTimeout(() => resolve(result), 10);
                            });
                        },
                        set: function(items) {
                            return new Promise((resolve) => {
                                Object.assign(this.data, items);
                                console.log('模拟存储 SET:', items);
                                setTimeout(() => resolve(), 10);
                            });
                        },
                        clear: function() {
                            return new Promise((resolve) => {
                                this.data = {};
                                console.log('模拟存储已清空');
                                setTimeout(() => resolve(), 10);
                            });
                        }
                    }
                }
            };
            
            updateTestStatus('Chrome API 模拟完成');
        }

        // 加载提示词助手脚本
        function loadPromptScripts() {
            updateTestStatus('开始加载脚本...');

            const scripts = [
                '../prompt/components/api.js',
                '../prompt/components/modal.js',
                '../prompt/sidepanel.js'
            ];

            let loadedCount = 0;

            function loadNextScript(index) {
                if (index >= scripts.length) {
                    updateTestStatus('所有脚本加载完成');
                    // 等待一下再初始化，确保所有脚本都执行完毕
                    setTimeout(() => {
                        if (window.promptApp) {
                            updateTestStatus('应用初始化成功');
                            testBasicFunctionality();
                        } else {
                            updateTestStatus('等待应用初始化...');
                            setTimeout(() => {
                                if (window.promptApp) {
                                    updateTestStatus('应用初始化成功');
                                    testBasicFunctionality();
                                } else {
                                    updateTestStatus('应用初始化失败');
                                }
                            }, 1000);
                        }
                    }, 500);
                    return;
                }

                const script = document.createElement('script');
                script.src = scripts[index];
                script.onload = () => {
                    loadedCount++;
                    updateTestStatus(`脚本 ${loadedCount}/${scripts.length} 加载完成`);
                    loadNextScript(index + 1);
                };
                script.onerror = () => {
                    updateTestStatus(`脚本 ${scripts[index]} 加载失败`);
                    loadNextScript(index + 1);
                };
                document.head.appendChild(script);
            }

            loadNextScript(0);
        }

        // 测试基本功能
        function testBasicFunctionality() {
            updateTestStatus('测试基本功能...');

            // 测试按钮点击
            setTimeout(() => {
                const addBtn = document.getElementById('promptAddBtn');
                if (addBtn) {
                    updateTestStatus('✓ 添加按钮可用');
                } else {
                    updateTestStatus('✗ 添加按钮不可用');
                }

                // 测试分类标签
                const categoryTabs = document.getElementById('promptCategoryTabs');
                if (categoryTabs && categoryTabs.children.length > 0) {
                    updateTestStatus('✓ 分类标签已渲染');
                } else {
                    updateTestStatus('✗ 分类标签未渲染');
                }

                // 测试提示词列表
                const promptList = document.getElementById('promptList');
                if (promptList && promptList.children.length > 0) {
                    updateTestStatus('✓ 提示词列表已渲染');
                } else {
                    updateTestStatus('✗ 提示词列表未渲染');
                }
            }, 1000);
        }

        // 页面加载完成后开始测试
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(loadPromptScripts, 100);
            });
        } else {
            setTimeout(loadPromptScripts, 100);
        }

        // 错误监听
        window.addEventListener('error', (event) => {
            updateTestStatus('错误: ' + event.message);
            console.error('页面错误:', event);
        });
    </script>
</body>
</html>
