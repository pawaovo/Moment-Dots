<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹ä¼˜åŒ–åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .platform-config {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>å†…å®¹æ™ºèƒ½ä¼˜åŒ–åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. æµ‹è¯•ç¯å¢ƒæ£€æŸ¥</h2>
        <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
        <div id="env-result"></div>
    </div>

    <div class="test-section">
        <h2>2. æç¤ºè¯é…ç½®æµ‹è¯•</h2>
        <div class="platform-config">
            <label>
                <input type="checkbox" id="weibo-enabled"> å¾®åš
                <select id="weibo-prompt">
                    <option value="">é€‰æ‹©æç¤ºè¯</option>
                </select>
            </label>
        </div>
        <div class="platform-config">
            <label>
                <input type="checkbox" id="xiaohongshu-enabled"> å°çº¢ä¹¦
                <select id="xiaohongshu-prompt">
                    <option value="">é€‰æ‹©æç¤ºè¯</option>
                </select>
            </label>
        </div>
        <button onclick="testPromptConfig()">æµ‹è¯•æç¤ºè¯é…ç½®</button>
        <div id="prompt-config-result"></div>
    </div>

    <div class="test-section">
        <h2>3. AIå†…å®¹ä¼˜åŒ–æµ‹è¯•</h2>
        <textarea id="test-content" placeholder="è¾“å…¥æµ‹è¯•å†…å®¹...">ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œæˆ‘æƒ³åˆ†äº«ä¸€äº›ç”Ÿæ´»æ„Ÿæ‚Ÿã€‚</textarea>
        <button onclick="testContentOptimization()">æµ‹è¯•å†…å®¹ä¼˜åŒ–</button>
        <div id="optimization-result"></div>
    </div>

    <div class="test-section">
        <h2>4. å‘å¸ƒæµç¨‹æµ‹è¯•</h2>
        <button onclick="testPublishFlow()">æµ‹è¯•å®Œæ•´å‘å¸ƒæµç¨‹</button>
        <div id="publish-flow-result"></div>
    </div>

    <script>
        // æ£€æŸ¥ç¯å¢ƒ
        async function checkEnvironment() {
            const resultDiv = document.getElementById('env-result');
            const results = [];

            try {
                // æ£€æŸ¥Chromeæ‰©å±•API
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    results.push({ type: 'success', message: 'âœ… Chromeæ‰©å±•APIå¯ç”¨' });
                } else {
                    results.push({ type: 'error', message: 'âŒ Chromeæ‰©å±•APIä¸å¯ç”¨' });
                }

                // æ£€æŸ¥å­˜å‚¨ä¸­çš„æç¤ºè¯
                const prompts = await chrome.storage.local.get(['prompts']);
                if (prompts.prompts && prompts.prompts.length > 0) {
                    results.push({ type: 'success', message: `âœ… æ‰¾åˆ° ${prompts.prompts.length} ä¸ªæç¤ºè¯` });
                    
                    // å¡«å……æç¤ºè¯é€‰æ‹©å™¨
                    fillPromptSelectors(prompts.prompts);
                } else {
                    results.push({ type: 'error', message: 'âŒ æœªæ‰¾åˆ°æç¤ºè¯é…ç½®' });
                }

                // æ£€æŸ¥AIè®¾ç½®
                const settings = await chrome.storage.local.get(['settings']);
                if (settings.settings && settings.settings.apiKey) {
                    results.push({ type: 'success', message: 'âœ… AI APIé…ç½®å·²è®¾ç½®' });
                } else {
                    results.push({ type: 'error', message: 'âŒ AI APIæœªé…ç½®' });
                }

            } catch (error) {
                results.push({ type: 'error', message: `âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // å¡«å……æç¤ºè¯é€‰æ‹©å™¨
        function fillPromptSelectors(prompts) {
            const selectors = ['weibo-prompt', 'xiaohongshu-prompt'];
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="">é€‰æ‹©æç¤ºè¯</option>';
                prompts.forEach(prompt => {
                    const option = document.createElement('option');
                    option.value = prompt.name;
                    option.textContent = prompt.name;
                    select.appendChild(option);
                });
            });
        }

        // æµ‹è¯•æç¤ºè¯é…ç½®
        async function testPromptConfig() {
            const resultDiv = document.getElementById('prompt-config-result');
            const results = [];

            try {
                // æ¨¡æ‹Ÿå¹³å°é…ç½®
                const testConfig = {
                    'weibo': {
                        isEnabled: document.getElementById('weibo-enabled').checked,
                        selectedPrompt: document.getElementById('weibo-prompt').value
                    },
                    'xiaohongshu': {
                        isEnabled: document.getElementById('xiaohongshu-enabled').checked,
                        selectedPrompt: document.getElementById('xiaohongshu-prompt').value
                    }
                };

                // ä¿å­˜é…ç½®åˆ°å­˜å‚¨
                await chrome.storage.local.set({ platformPromptConfig: testConfig });
                results.push({ type: 'success', message: 'âœ… æç¤ºè¯é…ç½®å·²ä¿å­˜' });

                // éªŒè¯é…ç½®
                const saved = await chrome.storage.local.get(['platformPromptConfig']);
                if (JSON.stringify(saved.platformPromptConfig) === JSON.stringify(testConfig)) {
                    results.push({ type: 'success', message: 'âœ… é…ç½®éªŒè¯æˆåŠŸ' });
                } else {
                    results.push({ type: 'error', message: 'âŒ é…ç½®éªŒè¯å¤±è´¥' });
                }

            } catch (error) {
                results.push({ type: 'error', message: `âŒ é…ç½®æµ‹è¯•å¤±è´¥: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // æµ‹è¯•å†…å®¹ä¼˜åŒ–
        async function testContentOptimization() {
            const resultDiv = document.getElementById('optimization-result');
            const content = document.getElementById('test-content').value;
            const results = [];

            if (!content.trim()) {
                results.push({ type: 'error', message: 'âŒ è¯·è¾“å…¥æµ‹è¯•å†…å®¹' });
                displayResults(resultDiv, results);
                return;
            }

            try {
                results.push({ type: 'info', message: 'ğŸ”„ å¼€å§‹å†…å®¹ä¼˜åŒ–æµ‹è¯•...' });
                displayResults(resultDiv, results);

                // è·å–ç¬¬ä¸€ä¸ªå¯ç”¨çš„æç¤ºè¯
                const prompts = await chrome.storage.local.get(['prompts']);
                if (!prompts.prompts || prompts.prompts.length === 0) {
                    results.push({ type: 'error', message: 'âŒ æ²¡æœ‰å¯ç”¨çš„æç¤ºè¯' });
                    displayResults(resultDiv, results);
                    return;
                }

                const testPrompt = prompts.prompts[0];
                results.push({ type: 'info', message: `ğŸ“ ä½¿ç”¨æç¤ºè¯: ${testPrompt.name}` });

                // æ¨¡æ‹ŸAIä¼˜åŒ–è¿‡ç¨‹
                const optimizedContent = await simulateAIOptimization(content, testPrompt);
                results.push({ type: 'success', message: `âœ… ä¼˜åŒ–å®Œæˆ` });
                results.push({ type: 'info', message: `åŸå§‹å†…å®¹: ${content}` });
                results.push({ type: 'info', message: `ä¼˜åŒ–åå†…å®¹: ${optimizedContent}` });

            } catch (error) {
                results.push({ type: 'error', message: `âŒ ä¼˜åŒ–æµ‹è¯•å¤±è´¥: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // æ¨¡æ‹ŸAIä¼˜åŒ–
        async function simulateAIOptimization(content, prompt) {
            // è¿™é‡Œæ¨¡æ‹ŸAIä¼˜åŒ–è¿‡ç¨‹
            await new Promise(resolve => setTimeout(resolve, 2000)); // æ¨¡æ‹Ÿ2ç§’å»¶è¿Ÿ
            return `[${prompt.name}ä¼˜åŒ–] ${content} #ä¼˜åŒ–å†…å®¹ #AIæ”¹å†™`;
        }

        // æµ‹è¯•å‘å¸ƒæµç¨‹
        async function testPublishFlow() {
            const resultDiv = document.getElementById('publish-flow-result');
            const results = [];

            try {
                results.push({ type: 'info', message: 'ğŸš€ å¼€å§‹å‘å¸ƒæµç¨‹æµ‹è¯•...' });
                displayResults(resultDiv, results);

                // æ¨¡æ‹Ÿå‘å¸ƒæµç¨‹çš„å„ä¸ªæ­¥éª¤
                const steps = [
                    'æ£€æŸ¥å¹³å°é…ç½®',
                    'è·å–éœ€è¦ä¼˜åŒ–çš„å¹³å°',
                    'æ‰§è¡Œå†…å®¹ä¼˜åŒ–',
                    'åˆ›å»ºå‘å¸ƒæ•°æ®',
                    'å‘é€åˆ°åå°è„šæœ¬'
                ];

                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    results.push({ type: 'success', message: `âœ… ${steps[i]}` });
                    displayResults(resultDiv, results);
                }

                results.push({ type: 'success', message: 'ğŸ‰ å‘å¸ƒæµç¨‹æµ‹è¯•å®Œæˆ' });

            } catch (error) {
                results.push({ type: 'error', message: `âŒ å‘å¸ƒæµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function displayResults(container, results) {
            container.innerHTML = results.map(result => 
                `<div class="test-result ${result.type}">${result.message}</div>`
            ).join('');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        window.addEventListener('load', checkEnvironment);
    </script>
</body>
</html>
