<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内容优化功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .platform-config {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>内容智能优化功能测试</h1>
    
    <div class="test-section">
        <h2>1. 测试环境检查</h2>
        <button onclick="checkEnvironment()">检查环境</button>
        <div id="env-result"></div>
    </div>

    <div class="test-section">
        <h2>2. 提示词配置测试</h2>
        <div class="platform-config">
            <label>
                <input type="checkbox" id="weibo-enabled"> 微博
                <select id="weibo-prompt">
                    <option value="">选择提示词</option>
                </select>
            </label>
        </div>
        <div class="platform-config">
            <label>
                <input type="checkbox" id="xiaohongshu-enabled"> 小红书
                <select id="xiaohongshu-prompt">
                    <option value="">选择提示词</option>
                </select>
            </label>
        </div>
        <button onclick="testPromptConfig()">测试提示词配置</button>
        <div id="prompt-config-result"></div>
    </div>

    <div class="test-section">
        <h2>3. AI内容优化测试</h2>
        <textarea id="test-content" placeholder="输入测试内容...">今天天气很好，我想分享一些生活感悟。</textarea>
        <button onclick="testContentOptimization()">测试内容优化</button>
        <div id="optimization-result"></div>
    </div>

    <div class="test-section">
        <h2>4. 发布流程测试</h2>
        <button onclick="testPublishFlow()">测试完整发布流程</button>
        <div id="publish-flow-result"></div>
    </div>

    <script>
        // 检查环境
        async function checkEnvironment() {
            const resultDiv = document.getElementById('env-result');
            const results = [];

            try {
                // 检查Chrome扩展API
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    results.push({ type: 'success', message: '✅ Chrome扩展API可用' });
                } else {
                    results.push({ type: 'error', message: '❌ Chrome扩展API不可用' });
                }

                // 检查存储中的提示词
                const prompts = await chrome.storage.local.get(['prompts']);
                if (prompts.prompts && prompts.prompts.length > 0) {
                    results.push({ type: 'success', message: `✅ 找到 ${prompts.prompts.length} 个提示词` });
                    
                    // 填充提示词选择器
                    fillPromptSelectors(prompts.prompts);
                } else {
                    results.push({ type: 'error', message: '❌ 未找到提示词配置' });
                }

                // 检查AI设置
                const settings = await chrome.storage.local.get(['settings']);
                if (settings.settings && settings.settings.apiKey) {
                    results.push({ type: 'success', message: '✅ AI API配置已设置' });
                } else {
                    results.push({ type: 'error', message: '❌ AI API未配置' });
                }

            } catch (error) {
                results.push({ type: 'error', message: `❌ 环境检查失败: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // 填充提示词选择器
        function fillPromptSelectors(prompts) {
            const selectors = ['weibo-prompt', 'xiaohongshu-prompt'];
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="">选择提示词</option>';
                prompts.forEach(prompt => {
                    const option = document.createElement('option');
                    option.value = prompt.name;
                    option.textContent = prompt.name;
                    select.appendChild(option);
                });
            });
        }

        // 测试提示词配置
        async function testPromptConfig() {
            const resultDiv = document.getElementById('prompt-config-result');
            const results = [];

            try {
                // 模拟平台配置
                const testConfig = {
                    'weibo': {
                        isEnabled: document.getElementById('weibo-enabled').checked,
                        selectedPrompt: document.getElementById('weibo-prompt').value
                    },
                    'xiaohongshu': {
                        isEnabled: document.getElementById('xiaohongshu-enabled').checked,
                        selectedPrompt: document.getElementById('xiaohongshu-prompt').value
                    }
                };

                // 保存配置到存储
                await chrome.storage.local.set({ platformPromptConfig: testConfig });
                results.push({ type: 'success', message: '✅ 提示词配置已保存' });

                // 验证配置
                const saved = await chrome.storage.local.get(['platformPromptConfig']);
                if (JSON.stringify(saved.platformPromptConfig) === JSON.stringify(testConfig)) {
                    results.push({ type: 'success', message: '✅ 配置验证成功' });
                } else {
                    results.push({ type: 'error', message: '❌ 配置验证失败' });
                }

            } catch (error) {
                results.push({ type: 'error', message: `❌ 配置测试失败: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // 测试内容优化
        async function testContentOptimization() {
            const resultDiv = document.getElementById('optimization-result');
            const content = document.getElementById('test-content').value;
            const results = [];

            if (!content.trim()) {
                results.push({ type: 'error', message: '❌ 请输入测试内容' });
                displayResults(resultDiv, results);
                return;
            }

            try {
                results.push({ type: 'info', message: '🔄 开始内容优化测试...' });
                displayResults(resultDiv, results);

                // 获取第一个可用的提示词
                const prompts = await chrome.storage.local.get(['prompts']);
                if (!prompts.prompts || prompts.prompts.length === 0) {
                    results.push({ type: 'error', message: '❌ 没有可用的提示词' });
                    displayResults(resultDiv, results);
                    return;
                }

                const testPrompt = prompts.prompts[0];
                results.push({ type: 'info', message: `📝 使用提示词: ${testPrompt.name}` });

                // 模拟AI优化过程
                const optimizedContent = await simulateAIOptimization(content, testPrompt);
                results.push({ type: 'success', message: `✅ 优化完成` });
                results.push({ type: 'info', message: `原始内容: ${content}` });
                results.push({ type: 'info', message: `优化后内容: ${optimizedContent}` });

            } catch (error) {
                results.push({ type: 'error', message: `❌ 优化测试失败: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // 模拟AI优化
        async function simulateAIOptimization(content, prompt) {
            // 这里模拟AI优化过程
            await new Promise(resolve => setTimeout(resolve, 2000)); // 模拟2秒延迟
            return `[${prompt.name}优化] ${content} #优化内容 #AI改写`;
        }

        // 测试发布流程
        async function testPublishFlow() {
            const resultDiv = document.getElementById('publish-flow-result');
            const results = [];

            try {
                results.push({ type: 'info', message: '🚀 开始发布流程测试...' });
                displayResults(resultDiv, results);

                // 模拟发布流程的各个步骤
                const steps = [
                    '检查平台配置',
                    '获取需要优化的平台',
                    '执行内容优化',
                    '创建发布数据',
                    '发送到后台脚本'
                ];

                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    results.push({ type: 'success', message: `✅ ${steps[i]}` });
                    displayResults(resultDiv, results);
                }

                results.push({ type: 'success', message: '🎉 发布流程测试完成' });

            } catch (error) {
                results.push({ type: 'error', message: `❌ 发布流程测试失败: ${error.message}` });
            }

            displayResults(resultDiv, results);
        }

        // 显示测试结果
        function displayResults(container, results) {
            container.innerHTML = results.map(result => 
                `<div class="test-result ${result.type}">${result.message}</div>`
            ).join('');
        }

        // 页面加载时自动检查环境
        window.addEventListener('load', checkEnvironment);
    </script>
</body>
</html>
