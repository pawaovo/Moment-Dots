<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试文章抓取测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>🐛 调试文章抓取测试</h1>
        <p>测试修复后的ArticleExtractorService.performExtraction函数</p>
    </div>

    <div class="test-container">
        <h2>🔧 调试测试</h2>
        <p>这个测试页面模拟扩展程序中的performExtraction函数执行过程</p>
        
        <button class="test-button" onclick="testPerformExtraction()">测试performExtraction函数</button>
        <button class="test-button" onclick="testJikeContent()">测试即刻内容结构</button>
        <button class="test-button" onclick="clearResults()">清空结果</button>
        
        <div id="debug-result" class="test-result"></div>
    </div>

    <!-- 加载Mozilla Readability库 -->
    <script src="../libs/readability/JSDOMParser.js"></script>
    <script src="../libs/readability/Readability.js"></script>
    <script src="../libs/readability/Readability-readerable.js"></script>
    
    <!-- 加载ArticleExtractorService -->
    <script src="../shared/services/ArticleExtractorService.js"></script>
    
    <script>
        // 工具函数
        function logResult(message, type = 'info') {
            const element = document.getElementById('debug-result');
            const timestamp = new Date().toLocaleTimeString();
            const statusIcon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            element.innerHTML += `[${timestamp}] ${statusIcon} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearResults() {
            document.getElementById('debug-result').innerHTML = '';
        }

        // 测试performExtraction函数
        async function testPerformExtraction() {
            clearResults();
            logResult('🎯 开始测试performExtraction函数...');
            
            try {
                // 检查函数是否存在
                if (typeof ArticleExtractorService.performExtraction !== 'function') {
                    logResult('❌ ArticleExtractorService.performExtraction函数不存在', 'error');
                    return;
                }
                
                logResult('✅ performExtraction函数存在');
                
                // 检查Readability库
                logResult('检查Readability库...');
                logResult(`isProbablyReaderable: ${typeof isProbablyReaderable}`);
                logResult(`Readability: ${typeof Readability}`);
                logResult(`JSDOMParser: ${typeof JSDOMParser}`);
                
                if (typeof isProbablyReaderable === 'undefined') {
                    logResult('❌ isProbablyReaderable未定义', 'error');
                    return;
                }
                
                if (typeof Readability === 'undefined') {
                    logResult('❌ Readability未定义', 'error');
                    return;
                }
                
                logResult('✅ Readability库检查通过');
                
                // 创建测试HTML
                const testHTML = createJikeTestHTML();
                const parser = new DOMParser();
                const testDoc = parser.parseFromString(testHTML, 'text/html');
                
                // 临时替换document对象进行测试
                const originalDoc = window.document;
                window.document = testDoc;
                
                logResult('开始执行performExtraction...');
                
                // 执行抓取函数
                const result = await ArticleExtractorService.performExtraction();
                
                // 恢复原始document
                window.document = originalDoc;
                
                logResult('performExtraction执行完成');
                
                if (result && result.error) {
                    logResult(`❌ 抓取失败: ${result.error}`, 'error');
                } else if (result) {
                    logResult('✅ 抓取成功!', 'success');
                    logResult(`标题: ${result.title}`);
                    logResult(`内容长度: ${result.length || result.content?.length || 0}`);
                    logResult(`平台: ${result.platform}`);
                    logResult(`阅读时间: ${result.readingTime}分钟`);
                } else {
                    logResult('❌ 返回结果为空', 'error');
                }
                
            } catch (error) {
                logResult(`❌ 测试异常: ${error.message}`, 'error');
                logResult(`错误堆栈: ${error.stack}`, 'error');
            }
        }

        // 测试即刻内容结构
        function testJikeContent() {
            clearResults();
            logResult('🎯 测试即刻内容结构...');
            
            const testHTML = createJikeTestHTML();
            const parser = new DOMParser();
            const testDoc = parser.parseFromString(testHTML, 'text/html');
            
            logResult(`页面标题: ${testDoc.title}`);
            logResult(`页面URL: ${testDoc.URL || 'test-url'}`);
            
            // 检查可读性
            const isReaderable = isProbablyReaderable(testDoc);
            logResult(`可读性检查: ${isReaderable ? '通过' : '失败'}`, isReaderable ? 'success' : 'error');
            
            // 尝试Readability解析
            try {
                const reader = new Readability(testDoc.cloneNode(true), {
                    charThreshold: 100,
                    debug: true
                });
                
                const article = reader.parse();
                
                if (article) {
                    logResult('✅ Readability解析成功', 'success');
                    logResult(`解析标题: ${article.title}`);
                    logResult(`内容长度: ${article.length}`);
                    logResult(`文本内容预览: ${article.textContent.substring(0, 100)}...`);
                } else {
                    logResult('❌ Readability解析失败', 'error');
                }
                
            } catch (error) {
                logResult(`❌ Readability解析异常: ${error.message}`, 'error');
            }
        }

        // 创建即刻测试HTML
        function createJikeTestHTML() {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>三个技巧，让你的产品在 Reddit 上狂刷存在感还不会被封 - 即刻App</title>
                    <meta name="description" content="你是否曾经想过在 Reddit 上推广自己的产品">
                </head>
                <body>
                    <div class="header">
                        <div class="app-info">即刻App</div>
                    </div>
                    
                    <main>
                        <article>
                            <div class="author-info">
                                <div class="author-name">Niko_</div>
                                <div class="publish-time">6天前</div>
                            </div>
                            
                            <div class="content">
                                <h1>三个技巧，让你的产品在 Reddit 上狂刷存在感还不会被封（含案例）</h1>
                                
                                <p>你是否曾经想过在 Reddit 上推广自己的产品，却担心因为"自我推广"而被封号？这确实是个需要谨慎对待的问题。</p>
                                
                                <p>通过深入分析大量成功案例，我总结了三种最有效且安全的推广方法，希望能为你提供一些参考。</p>
                                
                                <h2>【将产品融入故事叙述 📖】</h2>
                                <p>最高明的方式，不是直接宣传产品，而是将其自然地融入你的个人经历中。这种方式能够在不触发平台自我推广警报的情况下，让用户对你的产品产生兴趣。</p>
                                
                                <h3>真实案例：</h3>
                                <ul>
                                    <li>《我辞职全身心做SaaS》（406赞/188评）</li>
                                    <li>《十年前我融了250万刀，烧光之后我学到了这些》（652赞/109评）</li>
                                    <li>《终于来了——今天收获第一个付费用户！》（390赞/315评）</li>
                                </ul>
                                
                                <h3>实用技巧：</h3>
                                <ul>
                                    <li>✅ 保持故事为主，产品为辅</li>
                                    <li>✅ 用吸引人的开头引发好奇心</li>
                                    <li>✅ 适当展示你的专业背景</li>
                                    <li>✅ 用具体数据和截图增加可信度</li>
                                </ul>
                                
                                <h2>【提供高价值专业内容 💣】</h2>
                                <p>通过分享深度专业内容，如增长策略、SEO技巧或案例分析，你可以建立专业形象并间接推广产品。</p>
                                
                                <p>在 Reddit 上进行有效推广的关键在于：优先提供价值，自然融入产品信息。这种方法可能需要更多时间，但长期效果更为稳定和可持续。</p>
                                
                                <p>欢迎在评论区分享你的 Reddit 推广经验和心得，我们一起交流学习。</p>
                            </div>
                        </article>
                    </main>
                    
                    <aside>
                        <div class="topic-info">
                            <h2>来自圈子</h2>
                            <div class="topic">运营的日常</div>
                        </div>
                    </aside>
                </body>
                </html>
            `;
        }

        // 页面加载时的提示
        window.addEventListener('load', function() {
            logResult('🐛 调试测试页面已准备就绪', 'success');
            logResult('点击"测试performExtraction函数"开始调试', 'info');
        });
    </script>
</body>
</html>
