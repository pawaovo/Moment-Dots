<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŠ¶æ€ç®¡ç†æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .config-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª çŠ¶æ€ç®¡ç†æµ‹è¯•é¡µé¢</h1>
    <p>æµ‹è¯•æç¤ºè¯é…ç½®çŠ¶æ€æ¢å¤å’Œä¾§è¾¹æ çŠ¶æ€æ¸…ç†åŠŸèƒ½</p>

    <!-- æç¤ºè¯é…ç½®æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ“ æç¤ºè¯é…ç½®çŠ¶æ€æµ‹è¯•</h2>
        
        <div>
            <button class="test-button" onclick="testPromptConfigSave()">ä¿å­˜æµ‹è¯•é…ç½®</button>
            <button class="test-button" onclick="testPromptConfigLoad()">åŠ è½½é…ç½®çŠ¶æ€</button>
            <button class="test-button" onclick="testPromptConfigClear()">æ¸…é™¤é…ç½®</button>
        </div>
        
        <div id="promptConfigResults"></div>
        <div id="promptConfigDisplay" class="config-display"></div>
    </div>

    <!-- ä¾§è¾¹æ çŠ¶æ€æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ“Š ä¾§è¾¹æ çŠ¶æ€ç®¡ç†æµ‹è¯•</h2>
        
        <div>
            <button class="test-button" onclick="testCreatePublishResults()">åˆ›å»ºæµ‹è¯•å‘å¸ƒçŠ¶æ€</button>
            <button class="test-button" onclick="testLoadPublishResults()">åŠ è½½å‘å¸ƒçŠ¶æ€</button>
            <button class="test-button" onclick="testClearPublishResults()">æ¸…ç†å‘å¸ƒçŠ¶æ€</button>
            <button class="test-button" onclick="testResetPublishState()">é‡ç½®å‘å¸ƒçŠ¶æ€</button>
        </div>
        
        <div id="publishStateResults"></div>
        <div id="publishStateDisplay" class="config-display"></div>
    </div>

    <!-- ç»¼åˆæµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ”„ ç»¼åˆçŠ¶æ€æµ‹è¯•</h2>
        
        <div>
            <button class="test-button" onclick="testFullWorkflow()">å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•</button>
            <button class="test-button" onclick="testPageRefreshScenario()">é¡µé¢åˆ·æ–°åœºæ™¯æµ‹è¯•</button>
        </div>
        
        <div id="workflowResults"></div>
    </div>

    <script>
        // æµ‹è¯•æç¤ºè¯é…ç½®ä¿å­˜
        async function testPromptConfigSave() {
            const results = [];
            const resultDiv = document.getElementById('promptConfigResults');
            
            try {
                // åˆ›å»ºæµ‹è¯•é…ç½®
                const testConfig = {
                    'weibo': {
                        selectedPrompt: 'å¾®ä¿¡è¡¨æƒ…åŒ…æç¤ºè¯',
                        isEnabled: true,
                        availablePrompts: ['å¾®ä¿¡è¡¨æƒ…åŒ…æç¤ºè¯', 'è®ºæ–‡å¤§å¸ˆæç¤ºè¯']
                    },
                    'xiaohongshu': {
                        selectedPrompt: 'è®ºæ–‡å¤§å¸ˆæç¤ºè¯',
                        isEnabled: true,
                        availablePrompts: ['å¾®ä¿¡è¡¨æƒ…åŒ…æç¤ºè¯', 'è®ºæ–‡å¤§å¸ˆæç¤ºè¯']
                    }
                };

                await chrome.storage.local.set({ platformPromptConfig: testConfig });
                results.push({ type: 'success', message: 'âœ… æç¤ºè¯é…ç½®å·²ä¿å­˜' });
                
                // æ˜¾ç¤ºé…ç½®
                document.getElementById('promptConfigDisplay').textContent = JSON.stringify(testConfig, null, 2);
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ ä¿å­˜å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // æµ‹è¯•æç¤ºè¯é…ç½®åŠ è½½
        async function testPromptConfigLoad() {
            const results = [];
            const resultDiv = document.getElementById('promptConfigResults');
            
            try {
                const result = await chrome.storage.local.get(['platformPromptConfig']);
                const config = result.platformPromptConfig || {};
                
                results.push({ type: 'info', message: `ğŸ“– åŠ è½½é…ç½®æˆåŠŸï¼ŒåŒ…å« ${Object.keys(config).length} ä¸ªå¹³å°` });
                
                // æ˜¾ç¤ºé…ç½®
                document.getElementById('promptConfigDisplay').textContent = JSON.stringify(config, null, 2);
                
                // éªŒè¯é…ç½®ç»“æ„
                for (const [platformId, platformConfig] of Object.entries(config)) {
                    if (platformConfig.selectedPrompt) {
                        results.push({ 
                            type: 'success', 
                            message: `âœ… ${platformId}: ${platformConfig.selectedPrompt} (${platformConfig.isEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'})` 
                        });
                    }
                }
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ åŠ è½½å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // æµ‹è¯•æç¤ºè¯é…ç½®æ¸…é™¤
        async function testPromptConfigClear() {
            const results = [];
            const resultDiv = document.getElementById('promptConfigResults');
            
            try {
                await chrome.storage.local.remove(['platformPromptConfig']);
                results.push({ type: 'success', message: 'âœ… æç¤ºè¯é…ç½®å·²æ¸…é™¤' });
                
                document.getElementById('promptConfigDisplay').textContent = 'é…ç½®å·²æ¸…ç©º';
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ æ¸…é™¤å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // æµ‹è¯•åˆ›å»ºå‘å¸ƒçŠ¶æ€
        async function testCreatePublishResults() {
            const results = [];
            const resultDiv = document.getElementById('publishStateResults');
            
            try {
                const testPublishResults = [
                    {
                        platform: { id: 'weibo', name: 'å¾®åš' },
                        status: 'ready',
                        message: 'å†…å®¹å·²é¢„å¡«å……ï¼Œè¯·æ‰‹åŠ¨ç¡®è®¤å¹¶å‘å¸ƒ',
                        timestamp: Date.now()
                    },
                    {
                        platform: { id: 'xiaohongshu', name: 'å°çº¢ä¹¦' },
                        status: 'publishing',
                        message: 'æ­£åœ¨å‘å¸ƒä¸­...',
                        timestamp: Date.now()
                    }
                ];

                await chrome.storage.local.set({ 
                    publishResults: testPublishResults,
                    publishStatus: { isPublishing: true, timestamp: Date.now() }
                });
                
                results.push({ type: 'success', message: 'âœ… æµ‹è¯•å‘å¸ƒçŠ¶æ€å·²åˆ›å»º' });
                
                document.getElementById('publishStateDisplay').textContent = JSON.stringify(testPublishResults, null, 2);
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ åˆ›å»ºå¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // æµ‹è¯•åŠ è½½å‘å¸ƒçŠ¶æ€
        async function testLoadPublishResults() {
            const results = [];
            const resultDiv = document.getElementById('publishStateResults');
            
            try {
                const result = await chrome.storage.local.get(['publishResults', 'publishStatus']);
                const publishResults = result.publishResults || [];
                const publishStatus = result.publishStatus || {};
                
                results.push({ 
                    type: 'info', 
                    message: `ğŸ“– åŠ è½½å‘å¸ƒçŠ¶æ€æˆåŠŸï¼ŒåŒ…å« ${publishResults.length} ä¸ªå¹³å°ç»“æœ` 
                });
                
                if (publishStatus.isPublishing) {
                    results.push({ type: 'info', message: 'ğŸ”„ å½“å‰æ­£åœ¨å‘å¸ƒä¸­' });
                }
                
                document.getElementById('publishStateDisplay').textContent = JSON.stringify({
                    publishResults,
                    publishStatus
                }, null, 2);
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ åŠ è½½å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // æµ‹è¯•æ¸…ç†å‘å¸ƒçŠ¶æ€
        async function testClearPublishResults() {
            const results = [];
            const resultDiv = document.getElementById('publishStateResults');
            
            try {
                await chrome.storage.local.remove(['publishResults', 'publishStatus']);
                results.push({ type: 'success', message: 'âœ… å‘å¸ƒçŠ¶æ€å·²æ¸…ç†' });
                
                document.getElementById('publishStateDisplay').textContent = 'å‘å¸ƒçŠ¶æ€å·²æ¸…ç©º';
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ æ¸…ç†å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // æµ‹è¯•é‡ç½®å‘å¸ƒçŠ¶æ€
        async function testResetPublishState() {
            const results = [];
            const resultDiv = document.getElementById('publishStateResults');
            
            try {
                // æ¨¡æ‹Ÿå‘é€é‡ç½®æ¶ˆæ¯åˆ°åå°è„šæœ¬
                const response = await chrome.runtime.sendMessage({
                    action: 'resetPublishState',
                    data: {
                        reason: 'test',
                        selectedPlatforms: ['weibo', 'xiaohongshu']
                    }
                });
                
                if (response && response.success) {
                    results.push({ type: 'success', message: 'âœ… å‘å¸ƒçŠ¶æ€é‡ç½®æˆåŠŸ' });
                } else {
                    results.push({ type: 'error', message: 'âŒ å‘å¸ƒçŠ¶æ€é‡ç½®å¤±è´¥' });
                }
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ é‡ç½®å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•
        async function testFullWorkflow() {
            const results = [];
            const resultDiv = document.getElementById('workflowResults');
            
            try {
                results.push({ type: 'info', message: 'ğŸš€ å¼€å§‹å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•...' });
                
                // 1. ä¿å­˜æç¤ºè¯é…ç½®
                await testPromptConfigSave();
                results.push({ type: 'success', message: 'âœ… æ­¥éª¤1: æç¤ºè¯é…ç½®å·²ä¿å­˜' });
                
                // 2. åˆ›å»ºå‘å¸ƒçŠ¶æ€
                await testCreatePublishResults();
                results.push({ type: 'success', message: 'âœ… æ­¥éª¤2: å‘å¸ƒçŠ¶æ€å·²åˆ›å»º' });
                
                // 3. é‡ç½®å‘å¸ƒçŠ¶æ€
                await testResetPublishState();
                results.push({ type: 'success', message: 'âœ… æ­¥éª¤3: å‘å¸ƒçŠ¶æ€å·²é‡ç½®' });
                
                // 4. éªŒè¯æç¤ºè¯é…ç½®ä»ç„¶å­˜åœ¨
                const configResult = await chrome.storage.local.get(['platformPromptConfig']);
                if (configResult.platformPromptConfig && Object.keys(configResult.platformPromptConfig).length > 0) {
                    results.push({ type: 'success', message: 'âœ… æ­¥éª¤4: æç¤ºè¯é…ç½®ä¿æŒå®Œæ•´' });
                } else {
                    results.push({ type: 'error', message: 'âŒ æ­¥éª¤4: æç¤ºè¯é…ç½®ä¸¢å¤±' });
                }
                
                results.push({ type: 'success', message: 'ğŸ‰ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•å®Œæˆ' });
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ å·¥ä½œæµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // é¡µé¢åˆ·æ–°åœºæ™¯æµ‹è¯•
        async function testPageRefreshScenario() {
            const results = [];
            const resultDiv = document.getElementById('workflowResults');
            
            try {
                results.push({ type: 'info', message: 'ğŸ”„ æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°åœºæ™¯æµ‹è¯•...' });
                
                // æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°å‰çš„çŠ¶æ€
                await testPromptConfigSave();
                await testCreatePublishResults();
                
                results.push({ type: 'info', message: 'ğŸ“Š é¡µé¢åˆ·æ–°å‰çŠ¶æ€å·²è®¾ç½®' });
                
                // æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°åçš„çŠ¶æ€æ¢å¤
                const configResult = await chrome.storage.local.get(['platformPromptConfig']);
                const publishResult = await chrome.storage.local.get(['publishResults']);
                
                if (configResult.platformPromptConfig) {
                    results.push({ type: 'success', message: 'âœ… æç¤ºè¯é…ç½®æ­£ç¡®æ¢å¤' });
                }
                
                if (publishResult.publishResults) {
                    results.push({ type: 'info', message: 'âš ï¸ å‘å¸ƒçŠ¶æ€ä»ç„¶å­˜åœ¨ï¼ˆéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼‰' });
                }
                
                results.push({ type: 'info', message: 'ğŸ’¡ å»ºè®®ï¼šé¡µé¢åˆ·æ–°ååº”è¯¥æ¸…ç†å‘å¸ƒçŠ¶æ€ä½†ä¿ç•™æç¤ºè¯é…ç½®' });
                
            } catch (error) {
                results.push({ type: 'error', message: `âŒ é¡µé¢åˆ·æ–°åœºæ™¯æµ‹è¯•å¤±è´¥: ${error.message}` });
            }
            
            displayResults(resultDiv, results);
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function displayResults(container, results) {
            container.innerHTML = '';
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `result ${result.type}`;
                div.textContent = result.message;
                container.appendChild(div);
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰çŠ¶æ€
        window.addEventListener('load', async () => {
            await testPromptConfigLoad();
            await testLoadPublishResults();
        });
    </script>
</body>
</html>
