<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信公众号文章ID修复测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .platform-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .platform-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #f9f9f9;
        }
        
        .platform-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .platform-info {
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>微信公众号文章ID修复测试</h1>
        <p>测试 weixin-article ID 修复后的平台识别和跨标签页处理</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>1. 平台ID冲突检测</h3>
            <p>检测是否存在重复的平台ID：</p>
            <button class="test-button" onclick="testPlatformIdConflicts()">检测ID冲突</button>
            <div id="id-conflict-result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. 微信平台配置对比</h3>
            <p>对比常规微信公众号和文章专用微信公众号的配置：</p>
            <button class="test-button" onclick="testWeixinPlatformComparison()">对比平台配置</button>
            <div id="weixin-comparison-result" class="test-result" style="display: none;"></div>
            <div id="weixin-comparison-cards" class="platform-comparison" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. 跨标签页平台识别测试</h3>
            <p>模拟后台脚本的跨标签页平台识别逻辑：</p>
            <button class="test-button" onclick="testCrossTabPlatformDetection()">测试跨标签页识别</button>
            <div id="crosstab-detection-result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. 平台查找功能验证</h3>
            <p>验证 getPlatformById 函数能正确处理新的ID：</p>
            <button class="test-button" onclick="testPlatformLookupFunctionality()">验证查找功能</button>
            <div id="lookup-functionality-result" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- 引入平台配置文件 -->
    <script src="../shared/config/platforms.js"></script>
    
    <script>
        // 测试平台ID冲突
        function testPlatformIdConflicts() {
            const resultDiv = document.getElementById('id-conflict-result');
            resultDiv.style.display = 'block';
            
            try {
                let result = '✅ 平台ID冲突检测结果:\n\n';
                
                // 收集所有平台ID
                const allPlatforms = getAllPlatforms();
                const idCounts = {};
                
                allPlatforms.forEach(platform => {
                    idCounts[platform.id] = (idCounts[platform.id] || 0) + 1;
                });
                
                // 检查冲突
                const conflicts = Object.entries(idCounts).filter(([id, count]) => count > 1);
                
                if (conflicts.length === 0) {
                    result += '✅ 没有发现ID冲突\n\n';
                    result += '所有平台ID:\n';
                    Object.keys(idCounts).forEach(id => {
                        result += `  - ${id}\n`;
                    });
                    resultDiv.className = 'test-result success';
                } else {
                    result += '❌ 发现ID冲突:\n';
                    conflicts.forEach(([id, count]) => {
                        result += `  - ${id}: 出现 ${count} 次\n`;
                    });
                    resultDiv.className = 'test-result error';
                }
                
                resultDiv.textContent = result;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '❌ ID冲突检测失败\n' + error.message;
            }
        }
        
        // 测试微信平台配置对比
        function testWeixinPlatformComparison() {
            const resultDiv = document.getElementById('weixin-comparison-result');
            const cardsDiv = document.getElementById('weixin-comparison-cards');
            resultDiv.style.display = 'block';
            cardsDiv.style.display = 'grid';
            
            try {
                const weixinRegular = getPlatformById('weixin');
                const weixinArticle = getPlatformById('weixin-article');
                
                let result = '✅ 微信平台配置对比结果:\n\n';
                
                if (weixinRegular && weixinArticle) {
                    result += '两个平台都找到了:\n';
                    result += `常规微信公众号: ${weixinRegular.name}\n`;
                    result += `文章微信公众号: ${weixinArticle.name}\n\n`;
                    
                    // 检查关键差异
                    const differences = [];
                    if (weixinRegular.name !== weixinArticle.name) {
                        differences.push(`名称: "${weixinRegular.name}" vs "${weixinArticle.name}"`);
                    }
                    if (weixinRegular.publishUrl !== weixinArticle.publishUrl) {
                        differences.push(`URL: "${weixinRegular.publishUrl}" vs "${weixinArticle.publishUrl}"`);
                    }
                    if (weixinRegular.contentType !== weixinArticle.contentType) {
                        differences.push(`内容类型: "${weixinRegular.contentType || '未指定'}" vs "${weixinArticle.contentType || '未指定'}"`);
                    }
                    
                    if (differences.length > 0) {
                        result += '主要差异:\n';
                        differences.forEach(diff => result += `  - ${diff}\n`);
                    } else {
                        result += '⚠️ 除了ID外，两个平台配置完全相同\n';
                    }
                    
                    // 生成对比卡片
                    cardsDiv.innerHTML = `
                        <div class="platform-card">
                            <h4>常规微信公众号 (${weixinRegular.id})</h4>
                            <div class="platform-info">
                                <strong>名称:</strong> ${weixinRegular.name}<br>
                                <strong>URL:</strong> ${weixinRegular.publishUrl}<br>
                                <strong>域名:</strong> ${weixinRegular.domain}<br>
                                <strong>跨标签页:</strong> ${weixinRegular.crossTab ? '是' : '否'}<br>
                                <strong>内容类型:</strong> ${weixinRegular.contentType || '未指定'}
                            </div>
                        </div>
                        <div class="platform-card">
                            <h4>文章微信公众号 (${weixinArticle.id})</h4>
                            <div class="platform-info">
                                <strong>名称:</strong> ${weixinArticle.name}<br>
                                <strong>URL:</strong> ${weixinArticle.publishUrl}<br>
                                <strong>域名:</strong> ${weixinArticle.domain}<br>
                                <strong>跨标签页:</strong> ${weixinArticle.crossTab ? '是' : '否'}<br>
                                <strong>内容类型:</strong> ${weixinArticle.contentType || '未指定'}
                            </div>
                        </div>
                    `;
                    
                    resultDiv.className = 'test-result success';
                } else {
                    result += '❌ 平台查找失败:\n';
                    result += `常规微信公众号 (weixin): ${weixinRegular ? '找到' : '未找到'}\n`;
                    result += `文章微信公众号 (weixin-article): ${weixinArticle ? '找到' : '未找到'}\n`;
                    resultDiv.className = 'test-result error';
                }
                
                resultDiv.textContent = result;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '❌ 微信平台配置对比失败\n' + error.message;
            }
        }
        
        // 测试跨标签页平台识别
        function testCrossTabPlatformDetection() {
            const resultDiv = document.getElementById('crosstab-detection-result');
            resultDiv.style.display = 'block';
            
            try {
                let result = '✅ 跨标签页平台识别测试结果:\n\n';
                
                // 模拟后台脚本的跨标签页检测逻辑
                function mockHandleCrossTabPlatform(platformId) {
                    // 模拟修复后的逻辑
                    if (platformId === 'weixin' || platformId === 'weixin-article') {
                        return { success: true, message: '支持跨标签页发布' };
                    }
                    return { success: false, message: `Unsupported cross-tab platform: ${platformId}` };
                }
                
                const testPlatforms = ['weixin', 'weixin-article', 'weibo', 'bilibili'];
                
                testPlatforms.forEach(platformId => {
                    const platform = getPlatformById(platformId);
                    if (platform && platform.crossTab) {
                        const mockResult = mockHandleCrossTabPlatform(platformId);
                        if (mockResult.success) {
                            result += `✅ ${platformId} (${platform.name}): ${mockResult.message}\n`;
                        } else {
                            result += `❌ ${platformId} (${platform.name}): ${mockResult.message}\n`;
                        }
                    } else if (platform) {
                        result += `ℹ️ ${platformId} (${platform.name}): 非跨标签页平台\n`;
                    } else {
                        result += `❌ ${platformId}: 平台未找到\n`;
                    }
                });
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = result;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '❌ 跨标签页平台识别测试失败\n' + error.message;
            }
        }
        
        // 测试平台查找功能
        function testPlatformLookupFunctionality() {
            const resultDiv = document.getElementById('lookup-functionality-result');
            resultDiv.style.display = 'block';
            
            try {
                let result = '✅ 平台查找功能验证结果:\n\n';
                
                // 测试关键平台ID
                const testIds = [
                    'weixin',
                    'weixin-article', 
                    'weibo-article',
                    'bilibili-article',
                    'nonexistent-platform'
                ];
                
                testIds.forEach(id => {
                    const platform = getPlatformById(id);
                    if (platform) {
                        result += `✅ ${id}: 找到 "${platform.name}"\n`;
                        result += `   URL: ${platform.publishUrl}\n`;
                        result += `   内容类型: ${platform.contentType || '未指定'}\n\n`;
                    } else {
                        result += `❌ ${id}: 未找到\n\n`;
                    }
                });
                
                // 测试函数一致性
                result += '--- 函数一致性测试 ---\n';
                const testId = 'weixin-article';
                const byId = getPlatformById(testId);
                const byIds = getPlatformsByIds([testId]);
                const isValid = isValidPlatformId(testId);
                
                result += `getPlatformById('${testId}'): ${byId ? byId.name : '未找到'}\n`;
                result += `getPlatformsByIds(['${testId}']): ${byIds.length > 0 ? byIds[0].name : '未找到'}\n`;
                result += `isValidPlatformId('${testId}'): ${isValid}\n`;
                
                if (byId && byIds.length > 0 && isValid) {
                    result += '✅ 所有函数结果一致\n';
                    resultDiv.className = 'test-result success';
                } else {
                    result += '❌ 函数结果不一致\n';
                    resultDiv.className = 'test-result error';
                }
                
                resultDiv.textContent = result;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '❌ 平台查找功能验证失败\n' + error.message;
            }
        }
        
        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('微信公众号文章ID修复测试页面已加载');
            
            // 自动运行ID冲突检测
            setTimeout(() => {
                testPlatformIdConflicts();
            }, 500);
        });
    </script>
</body>
</html>
