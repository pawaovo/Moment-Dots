🔍 Chrome Extension消息传递限制验证
官方限制确认
根据Chrome官方文档和Stack Overflow的验证：

Native Messaging: 明确限制为 64MB
runtime.sendMessage: 实际限制约 50MB (经过JSON序列化后)
消息序列化开销: Array转JSON会显著增加数据大小
💡 验证可行的改进方案
方案1: 分块下载机制（推荐⭐⭐⭐⭐⭐）
技术原理：

// 类似上传的分块机制，但用于下载
getFileInChunks(fileId, chunkSize = 16MB) {
  // 1. 获取文件元数据
  // 2. 计算分块数量
  // 3. 逐块请求文件数据
  // 4. Content Script端重组
}
优势：

✅ 与现有分块上传架构一致
✅ 可处理任意大小文件
✅ 内存使用可控
✅ 实现复杂度适中
实现要点：

Background Script按块返回数据
Content Script逐块接收并重组
保持与现有API兼容
方案2: Base64分块传输（推荐⭐⭐⭐⭐）
技术原理：

// 将ArrayBuffer转为Base64分块传输
const base64Chunk = btoa(String.fromCharCode(...uint8Array.slice(start, end)));
优势：

✅ Base64编码稳定可靠
✅ 减少JSON序列化开销
✅ 支持流式传输
✅ 兼容性好
数据大小对比：

50MB文件:
- Array方式: ~100-150MB (JSON序列化)
- Base64方式: ~67MB (33%增长)
- 分块Base64: 每块<16MB，总体可控
方案3: Blob URL传递（推荐⭐⭐⭐）
技术原理：

// Background Script创建Blob URL
const blobUrl = URL.createObjectURL(blob);
// 传递URL而非数据
sendResponse({ success: true, blobUrl: blobUrl, metadata: metadata });
限制：

❌ 跨上下文Blob URL访问受限
❌ 需要验证Chrome Extension中的可行性
⚠️ 可能需要特殊权限
方案4: IndexedDB直接访问（推荐⭐⭐）
技术原理：

// Content Script直接访问IndexedDB
const file = await indexedDB.getFile(fileId);
优势：

✅ 避免消息传递限制
✅ 性能最优
限制：

❌ 需要重构现有架构
❌ 跨上下文数据库访问复杂
🛠️ 推荐实施方案：分块下载
实现架构
// Background Script端
async function getFileChunk(fileId, chunkIndex, chunkSize) {
  const fileData = this.getFile(fileId);
  const start = chunkIndex * chunkSize;
  const end = Math.min(start + chunkSize, fileData.blob.size);
  
  const chunk = fileData.blob.slice(start, end);
  const arrayBuffer = await chunk.arrayBuffer();
  const uint8Array = new Uint8Array(arrayBuffer);
  

渐进式实施策略
阶段1: 添加分块下载API

保持现有getFile API不变
添加新的getFileChunked API
小文件继续使用原有方式
阶段2: 智能路由

async function getFileFromExtension(fileId) {
  // 先尝试获取文件大小
  const metadata = await getFileMetadata(fileId);
  
  if (metadata.size > 16 * 1024 * 1024) { // 🚀 16MB阈值（优化后）
    return await getFileFromExtensionChunked(fileId);
  } else {
    return await getFileFromExtensionLegacy(fileId);
  }
}
阶段3: 完全迁移

所有文件使用分块下载
移除原有getFile实现
📊 方案对比总结
方案	实现难度	性能	兼容性	可靠性	推荐度
分块下载	中等	好	优秀	优秀	⭐⭐⭐⭐⭐
Base64分块	简单	中等	优秀	好	⭐⭐⭐⭐
Blob URL	简单	优秀	未知	未知	⭐⭐⭐
IndexedDB直接	复杂	优秀	中等	好	⭐⭐
🎯 最终建议
立即实施：分块下载机制

与现有架构最兼容
解决根本问题
备选方案：Base64分块传输

作为分块下载的补充
用于特殊场景优化
这个方案经过网络资料验证，技术可行，风险可控，是解决大文件传输问题的最佳选择。